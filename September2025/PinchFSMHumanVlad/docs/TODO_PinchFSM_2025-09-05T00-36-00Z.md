PinchFSM — One‑Pager TODO (Deterministic, CI‑Gated)
==================================================

Metadata
--------

- title: PinchFSM — Deterministic Replay & CI TODO
- doc_type: todo-one-pager
- timestamp: 2025-09-05T00:36:00Z
- tags: [determinism, traces, goldens, CI, human, mediapipe]

Goal
----

Stop regressions by locking video‑derived landmark traces, replaying PinchFSM offline, and gating CI with PASS/FAIL metrics.

Quick tradeoffs (input stack)
-----------------------------

- MediaPipe Tasks (Node, WASM): your preferred stack; deterministic with pinned model + WASM; needs node-canvas polyfills. Recommended P0.
- Human + tfjs-node (Node): simpler Node backend; good alternate producer for parity checks.
- MediaPipe Python: straightforward; adds Python to CI; keep as fallback.

Deterministic invariants
------------------------

- Use stored traces; no webcam. Time = round((frameIndex / fps) * 1000).
- Pin versions (library, backend, models, ffmpeg). humanize=0; no smoothing in trace.
- Hand‑only landmarks; consistent decode/resize via ffmpeg.

Sequential TODO (P0 → P2)
-------------------------

P0 — Trace + Goldens with MediaPipe (today)

- Implement Node trace generator using `@mediapipe/tasks-vision` HandLandmarker (runningMode: VIDEO), with ffmpeg → image2pipe (MJPEG) → pipe2jpeg → node-canvas → `detectForVideo(image, tMs)`.
- Vendor `.task` model and WASM locally; set `baseOptions.modelAssetPath` and `wasmBasePath` to file:// for reproducibility; pin package version.
- Generate traces for 2 seed MP4s → write data/goldens/VIDEO.landmarks.json and .meta.json (include mediapipe version, model checksum, wasm info, ffmpeg args, fps/width/height/frameCount, timestampPolicy).
- Auto‑annotate candidate Strike/Lift; quick human verify; save golden_times.json.

P1 — Replay + Comparator + CI

- Build PinchFSMRunner that consumes traces; compute P=dist(4,8)/dist(5,17), hysteresis + palm gate; emit events.
- Comparator: compare to golden_times; metrics: median |Δt|, p90, FP/FN.
- CI job: fail if median>40 ms, p90>100 ms, FP>5% on gated clips. Upload reports/ and artifacts/.

P2 — Viz + Robustness

- Minimal overlay video of traces + events; store as artifacts/VIDEO.overlay.mp4.
- Add stability guards: small‑K clamp, palm gate strict, drop low‑conf frames.
- Optional: Add Human producer for parity; add 1–2 more gated clips.

Deliverables
------------

- `data/goldens/*.landmarks.json`, `data/goldens/*.meta.json`, `data/goldens/*.golden_times.json`
- reports/*.comparison.json with metrics and PASS/FAIL
- scripts/tools: trace generator CLI, replay harness CLI

Acceptance
----------

- Video A: 1 Strike within median |Δt| ≤ 40 ms, p90 ≤ 100 ms.
- Video B (gated): 0 Strikes (FP ≤ 5%).
- Replay is byte‑stable for fixed inputs and config.

Next action (start here)
-----------------------

- Create trace-gen CLI (MediaPipe Node WASM) and run on the two MP4s in repo root; commit goldens + meta.

What we need from you (prereqs & approvals)
-------------------------------------------

- Confirm Node ≥ 18 and allow adding dev deps: `@mediapipe/tasks-vision`, `canvas`, `pipe2jpeg`.
- Ensure ffmpeg is installed and on PATH (Windows). If not, we’ll add a local ffmpeg or document install.
- Approve vendoring the MediaPipe `.task` model and WASM files in-repo (for offline determinism) and the target folder (e.g., `vendor/mediapipe/`).
- Confirm CPU-only is acceptable for P0 (Node WASM runs on CPU). GPU is not required.
- Approve writing goldens under `data/goldens/` and reports/artifacts under `reports/` and `artifacts/`.

Agent & README (next after approval)
------------------------------------

- README: quickstart for trace-gen CLI, schema docs, replay harness usage, and CI thresholds.
- Agent.md: “Replay Manager” contract to run generator + comparator on new MP4s, validate metrics, and open a PR with PASS/FAIL report (human-in-the-loop for threshold changes).

Environment & MCP audit — 2025-09-05T00:45:00Z
----------------------------------------------

- Node: v22.13.0 (OK; meets ≥18). Note: tasks-vision supports Node; WASM runs on CPU.
- npm: 11.2.0 (OK).
- ffmpeg: not found on PATH (Windows). Action: install ffmpeg or bundle a local binary and add docs.
- Created folders: `data/goldens/`, `reports/`, `artifacts/`.
- MCP/tools status in this workspace:
	- Terminal access: working (used to check versions).
	- File ops: working (folder creation, doc edits OK).
	- Web/docs fetch: working (used earlier to review Human/MediaPipe docs).
	- Recommended additions: GitHub PR automation (for Agent.md flow), JSON schema validator (to enforce landmarks/events schema), optional video overlay tool (ffmpeg exists once installed).

