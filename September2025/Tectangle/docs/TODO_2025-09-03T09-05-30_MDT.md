# TODO — Pinch 4-way + Palm/Orientation Gating + Basic TOI

- Created: 2025-09-03T09:05:30 MDT
- UTC: 2025-09-03T15:05:30Z

One-line summary: Implement reliable detection of four distinct pinch gestures, add orientation/palm gating to reduce false positives, and add a basic Time-Of-Impact (TOI) calculation to improve tlatency.

Today's Top Objectives

- Working 4 distinct pinches detected and emitted reliably.
- Orientation / palm gating to reject palm/edge contact.
- Basic TOI calculation integrated to improve event timing (tlatency).

Tasks (2–4 hour chunks)

1. Branch & scaffold — 2 hours
   - Create a feature branch and add this TODO to the branch.
   - Files to touch: [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1), [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1).

2. Pinch baseline: implement 4-way detection — 3 hours
   - Extend the existing baseline logic to emit four distinct pinch types and canonicalize output for downstream routing.
   - Tests/refs: [`September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl`](September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl:1), [`September2025/Tectangle/tests/smoke/pinch.baseline.smoke.test.mjs`](September2025/Tectangle/tests/smoke/pinch.baseline.smoke.test.mjs:1).

3. Orientation & palm gating — 3 hours
   - Add palm/orientation gating rules (palm normal, wrist angle, bulk contact) to reduce false positives.
   - Visualize and iterate using: [`September2025/Tectangle/prototype/landmark-smooth/index-src.html`](September2025/Tectangle/prototype/landmark-smooth/index-src.html:1) and [`September2025/Tectangle/prototype/common/manager-bootstrap.js`](September2025/Tectangle/prototype/common/manager-bootstrap.js:1).

4. Basic TOI calculation & integration — 3 hours
   - Add a simple TOI estimator (approach velocity + distance -> estimated impact time) and attach it to pinch events.
   - Integrate TOI into telemetry and baseline: [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1), [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1).

5. Visualization + trace capture — 2–4 hours
   - Add on-screen overlays for candidate pinches and TOI; capture golden traces to tests/golden.
   - Prototype page: [`September2025/Tectangle/prototype/landmark-smooth/index-src.html`](September2025/Tectangle/prototype/landmark-smooth/index-src.html:1).

6. Golden traces & tests — 2 hours
   - Update golden traces and ensure smoke tests reflect 4-pinches: [`September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl`](September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl:1).

7. Telemetry & dashboards — 2–4 hours
   - Ensure TOI and gating events are emitted and stored: [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1).

8. Unit & smoke tests — 2–4 hours
   - Update/author tests: [`September2025/Tectangle/tests/unit/manager-registry.test.js`](September2025/Tectangle/tests/unit/manager-registry.test.js:1), [`September2025/Tectangle/tests/smoke/pinch.baseline.smoke.test.mjs`](September2025/Tectangle/tests/smoke/pinch.baseline.smoke.test.mjs:1).

Acceptance criteria

- Four distinct pinch types emitted in prototype and smoke tests.
- Gating reduces palm-triggered false positives in golden traces to an operationally acceptable level.
- TOI value available in telemetry and visibly reduces perceived tlatency in the prototype overlay.

Decision Grid

Recommended: **Exploit** — pragmatic, fastest route to a working feature set

1) Explore
   - Summary: Rapidly prototype multiple detection heuristics and TOI estimators to gather data and identify edge cases before committing to a single approach.
   - Impact: Medium
   - Risk: Low
   - Effort: 1–3 days
   - Concrete NextStep: Create branch `explore/pinch-probe`, instrument [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1) and [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1), collect traces to [`September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl`](September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl:1).

2) Exploit
   - Summary: Implement deterministic 4-way pinch logic in the baseline, add pragmatic gating and a simple TOI estimator — the fastest route to shipable behavior.
   - Impact: High
   - Risk: Medium
   - Effort: 1–2 days
   - Concrete NextStep: Branch `feat/pinch-4way-TOI`, update [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1) and [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1); validate with [`September2025/Tectangle/tests/smoke/pinch.baseline.smoke.test.mjs`](September2025/Tectangle/tests/smoke/pinch.baseline.smoke.test.mjs:1).

3) Pivot
   - Summary: Pivot to a lightweight ML classifier trained on labeled traces to distinguish pinch types more robustly than heuristics.
   - Impact: High
   - Risk: High
   - Effort: days → weeks
   - Concrete NextStep: Start an experiment under [`September2025/Tectangle/prototype/landmark-smooth/index-src.html`](September2025/Tectangle/prototype/landmark-smooth/index-src.html:1), export labeled traces from [`September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl`](September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl:1) and iterate.

4) Reorient
   - Summary: Defer full 4-way detection and focus on gating + TOI to get immediate quality improvements and reduce false positives.
   - Impact: Medium
   - Risk: Low
   - Effort: 6–12 hours
   - Concrete NextStep: Update gating logic in [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1) and TOI in [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1); validate on the prototype page [`September2025/Tectangle/prototype/landmark-smooth/index-src.html`](September2025/Tectangle/prototype/landmark-smooth/index-src.html:1).

Immediate Next Action

- Create the feature branch and open the baseline file for edits. (Example command to run in your shell; not executed here)

git checkout -b feat/pinch-4way-TOI && code September2025/Tectangle/src/gesture/pinchBaseline.js

Notes / references

- Prototype diagnostics: [`September2025/Tectangle/prototype/landmark-smooth/console-diagnostic-2025-09-02T21-18-26Z.js`](September2025/Tectangle/prototype/landmark-smooth/console-diagnostic-2025-09-02T21-18-26Z.js:1)
- Summary doc: [`September2025/Tectangle/docs/Tectangle_Summary_2025-09-02T18-27-10Z.md`](September2025/Tectangle/docs/Tectangle_Summary_2025-09-02T18-27-10Z.md:1)

— End TODO

Pipeline Audit & Tests (added 2025-09-03)

Short summary: Prototype and verify the Camera → LandmarkRaw → LandmarkSmooth → KinematicClamp pipeline to reduce teleporting; audit managers for clear headers and Mocha-compatible unit tests; improve pinch baseline and telemetry and verify PinchManager + TelemetryManager behavior.

Today's Top Objectives (updated)

- Verify Camera → LandmarkRaw → LandmarkSmooth → KinematicClamp pipeline reduces teleport-like jumps (teleporting).
- Audit and add unit-testable headers to managers and migrate any `node:test` usages to Mocha where appropriate.
- Improve pinch baseline and telemetry; add PinchManager and TelemetryManager verification and TOI gating tests.

Tasks (2–4 hour chunks)

- [ ] Audit CameraManager — verify public header, exports, start/reconfigure/stop, and that it emits `camera:params` and `camera:frame` (2–4h). Files: [`September2025/Tectangle/src/CameraManager.js`](September2025/Tectangle/src/CameraManager.js:1).
- [ ] Audit LandmarkRawManager — verify setConfig echo, deterministic Node fallback, `landmark:raw` emission shape and MediaPipe init hooks (2–4h). Files: [`September2025/Tectangle/src/LandmarkRawManager.js`](September2025/Tectangle/src/LandmarkRawManager.js:1).
- [ ] Audit LandmarkSmoothManager — verify OneEuro params, start/stop, computeSmoothed, and `landmark:smoothed` shape (2–4h). Files: [`September2025/Tectangle/src/LandmarkSmoothManager.js`](September2025/Tectangle/src/LandmarkSmoothManager.js:1).
- [ ] Audit KinematicClampManager — verify clamp API, integration points with smoothing, exports and test hooks (2–4h). Files: [`September2025/Tectangle/src/KinematicClampManager.js`](September2025/Tectangle/src/KinematicClampManager.js:1).
- [ ] Audit Pinch baseline & manager surface — ensure pinchBaseline produces canonical events and identify PinchManager/PinchRecognition interfaces to test (2–4h). Files: [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1).
- [ ] Audit Telemetry (pinchTelemetry) & TelemetryManager surface — verify TOI fields are emitted and telemetry API compatibility (2–4h). Files: [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1).
- [ ] Audit ManagerRegistry — confirm register/get/unregister/list behavior and add header test hooks (1–2h). Files: [`September2025/Tectangle/src/ManagerRegistry.js`](September2025/Tectangle/src/ManagerRegistry.js:1).

- [ ] Create/update header unit tests for each manager (place under [`September2025/Tectangle/tests/unit/`](September2025/Tectangle/tests/unit/:1)) — create minimal 'header' tests that assert export shape and public API presence (2–4h per manager).

- [ ] Convert `node:test` usages to Mocha when they block CI or are incompatible with the existing test harness; provide Mocha-compatible skeletons under [`September2025/Tectangle/tests/unit/`](September2025/Tectangle/tests/unit/:1) (2–6h).

- [ ] Pinch baseline tuning & telemetry adjustments — iterate baseline thresholds, gating rules and add TOI attachments to pinch events (2–4h). Files: [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1), [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1).

- [ ] Implement a basic TOI estimator (approach velocity + distance) and add unit tests including a palm/orientation gating test that asserts rejection of palm/edge cases (2–4h).

- [ ] Add golden traces to [`September2025/Tectangle/tests/golden/`](September2025/Tectangle/tests/golden/:1) and smoke tests under [`September2025/Tectangle/tests/smoke/`](September2025/Tectangle/tests/smoke/:1) — include a golden trace for the canonical 4-pinches and gating cases (2–4h).

- [ ] Compatibility checklist (legacy naming & headers) — check code for `PinchRecognitionManager` vs `PinchManager` naming, ensure header meta keys (HEADER_META_START) are present, and ensure tests import default vs named exports consistently (1–2h).

Manager Audit Checklist

- CameraManager — [`September2025/Tectangle/src/CameraManager.js`](September2025/Tectangle/src/CameraManager.js:1):
  - Exports: default class; constructor({ eventBus, mediaDevices, videoElement, width, height, fps, source, videoFile })
  - Init/API: start(), reconfigure(), stop(), setVideoElement(), setMirror()/toggleMirror()
  - Events: 'camera:params', 'camera:frame', 'camera.stream.started', 'camera.stream.stopped', 'camera.device.changed', 'camera.mirror.toggled'
  - Testable behavior: synthetic deterministic frame on start, frameId increments, reconfigure publishes updated camera:params.

- LandmarkRawManager — [`September2025/Tectangle/src/LandmarkRawManager.js`](September2025/Tectangle/src/LandmarkRawManager.js:1):
  - Exports: default class; constructor(options) with useMediaPipe flag and videoElement
  - Init/API: setConfig(), setVideoElement(), destroy()
  - Events: publishes 'landmark:raw', echoes 'landmarkraw.config'
  - Testable behavior: deterministic synthetic landmarks on camera:frame, config echo, low-confidence gating.

- LandmarkSmoothManager — [`September2025/Tectangle/src/LandmarkSmoothManager.js`](September2025/Tectangle/src/LandmarkSmoothManager.js:1):
  - Exports: default class; start(), stop(), setConfig(), setPreset() and computeSmoothed() pure helper
  - Events: listens for 'landmark:raw' and emits 'landmark:smoothed'
  - Testable behavior: OneEuro filtering per-keypoint, computePalmWidth helper, preset application resets filters.

- KinematicClampManager — [`September2025/Tectangle/src/KinematicClampManager.js`](September2025/Tectangle/src/KinematicClampManager.js:1):
  - Exports: confirm API surface (applyClamp / setConfig / init hooks)
  - Events: expected to subscribe to 'landmark:smoothed' or similar and publish clamped variants
  - Testable behavior: ensure clamp prevents unrealistic jumps and preserves continuity.

- Pinch baseline / PinchManager — [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1):
  - Exports: baseline functions or default manager-like object; check for canonical pinch event shape
  - Events: candidate pinch emission, canonical pinch event, gating flags (palm/orientation/TOI)
  - Testable behavior: deterministic 4-way pinch outputs for golden traces.

- Pinch telemetry / TelemetryManager — [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1):
  - Exports: telemetry hooks/collectors; ensure TOI and gating info included in telemetry envelopes
  - Testable behavior: telemetry receives pinch events and records TOI / gating metrics.

- ManagerRegistry — [`September2025/Tectangle/src/ManagerRegistry.js`](September2025/Tectangle/src/ManagerRegistry.js:1):
  - Exports: register(), unregister(), get(), getMeta(), has(), list(), default export compatibility
  - Testable behavior: registering returns same instance, getMeta echoes provided meta, unregister removes entries.

Decision Grid

Recommended: **Exploit** — implement the deterministic pipeline + test scaffolding and iterate quickly.

Explore
- Summary: Rapidly prototype multiple detection heuristics and pipeline helpers to collect traces and identify edge cases before committing to a single implementation.
- Impact: Medium
- Risk: Low
- Effort: 1–3 days
- Precise NextStep: Create branch `explore/pipeline-probe`, instrument [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1), [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1) and add lightweight instrumentation to [`September2025/Tectangle/src/CameraManager.js`](September2025/Tectangle/src/CameraManager.js:1) and [`September2025/Tectangle/src/LandmarkRawManager.js`](September2025/Tectangle/src/LandmarkRawManager.js:1) to collect golden traces into [`September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl`](September2025/Tectangle/tests/golden/pinch_baseline_01.jsonl:1).

Exploit (RECOMMENDED)
- Summary: Implement deterministic 4-way pinch logic in the baseline, add pragmatic gating and a simple TOI estimator, and create header unit tests so CI can catch regressions quickly.
- Impact: High
- Risk: Medium
- Effort: 1–2 days
- Precise NextStep: Branch `feat/pipeline-audit-tests`; update [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1), [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1), and author header tests under [`September2025/Tectangle/tests/unit/`](September2025/Tectangle/tests/unit/:1) that assert manager headers and basic event contracts. Start with `CameraManager`, `LandmarkRawManager`, `LandmarkSmoothManager`, `KinematicClampManager`, `ManagerRegistry`.

Pivot
- Summary: Pivot to a lightweight ML classifier trained on labeled traces to distinguish pinch types more robustly than heuristics.
- Impact: High
- Risk: High
- Effort: days → weeks
- Precise NextStep: Begin an experiment under [`September2025/Tectangle/prototype/landmark-smooth/index-src.html`](September2025/Tectangle/prototype/landmark-smooth/index-src.html:1), export labeled traces, and iterate.

Reorient
- Summary: Defer full 4-way detection and prioritize gating + TOI + tests to immediately reduce false positives and stabilize the pipeline.
- Impact: Medium
- Risk: Low
- Effort: 6–12 hours
- Precise NextStep: Update gating in [`September2025/Tectangle/src/gesture/pinchBaseline.js`](September2025/Tectangle/src/gesture/pinchBaseline.js:1) and TOI in [`September2025/Tectangle/src/telemetry/pinchTelemetry.js`](September2025/Tectangle/src/telemetry/pinchTelemetry.js:1); validate with prototype page [`September2025/Tectangle/prototype/landmark-smooth/index-src.html`](September2025/Tectangle/prototype/landmark-smooth/index-src.html:1).

Immediate Next Action

- [ ] Create branch `feat/pipeline-audit-tests` and confirm the branch exists; skeleton header tests will be placed under [`September2025/Tectangle/tests/unit/`](September2025/Tectangle/tests/unit/:1).