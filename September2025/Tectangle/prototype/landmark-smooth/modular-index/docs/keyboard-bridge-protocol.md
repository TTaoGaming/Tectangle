# Keyboard Bridge Protocol (spec)

This document specifies a minimal JSON-over-WebSocket protocol for transporting virtual key events produced by the gesture pipeline to a remote bridge service.

Protocol basics
- Transport: WebSocket (wss:// recommended for production)
- Messages: newline-delimited JSON objects (one JSON object per WebSocket message)
- Direction: client -> server (key events emitted by browser); server -> client not defined here.

Common fields
- type: string — message type, e.g. "keyDown", "keyUp", "ping"
- key: string — keyboard key identifier (e.g. "A", "Enter")
- controllerId: integer — stable controller id assigned by client pipeline
- timestampMs: integer — epoch ms generated by client (Date.now())
- predictedTtiMs: integer|null — optional predicted time-to-interaction in ms (if available)

Example messages
- Key down (press):
  {
    "type": "keyDown",
    "key": "A",
    "controllerId": 1,
    "timestampMs": 1690000000000,
    "predictedTtiMs": 120
  }

- Key up (release):
  {
    "type": "keyUp",
    "key": "A",
    "controllerId": 1,
    "timestampMs": 1690000001300,
    "predictedTtiMs": null
  }

Security considerations
- Always use wss:// in production and validate server certificates.
- Authentication: include an Authorization header during WebSocket upgrade or send an initial auth message after connect.
- Rate limiting: servers should implement per-connection rate limits to avoid abusive clients.
- Replay protection: include timestampMs and optionally a monotonic sequence number if required.

Server behavior (recommended)
- Validate incoming JSON and required fields.
- Map controllerId to server-side session if needed.
- Optionally translate to OS-native keyboard events (platform-specific).
- Log events with timestamps and controllerId for debugging and telemetry.

Client behavior (recommended)
- Buffer transient disconnects and retry with exponential backoff.
- Optionally batch or debounce high-frequency events (but preserve ordering).
- Send periodic keepalive ping messages if connection idle.

Notes
- This spec is intentionally small and geared for prototype/demo usage. Extend fields (e.g., velocity, confidence, handedness) as needed for longer-term integration.