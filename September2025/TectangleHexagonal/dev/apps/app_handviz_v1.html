<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>App â€¢ Hand Viz V1</title>
<link rel="stylesheet" href="../design/m3.tokens.css" />
<style>
  html,body{height:100%;margin:0}
  body{background: var(--m3-surface); color: var(--m3-on-surface); font:12px/1.2 system-ui}
  .wrap{padding:8px}
  canvas{width:100%;height:160px;background: color-mix(in oklab, var(--m3-surface) 80%, black 20%);border-radius: var(--m3-radius-sm);border:1px solid var(--m3-outline)}
</style>
</head>
<body>
  <div class="wrap">
    <div style="margin-bottom:6px;opacity:.75">Hand Viz (placeholder)</div>
    <canvas id="cv" width="320" height="160"></canvas>
  </div>
  <script type="module">
  import { createBus } from '../../src/overlay/overlay_bus.mjs';
  const g = document.getElementById('cv').getContext('2d');
  const bus = createBus('overlay-bus');
  let hands = []; // [{label, handedness:'Left'|'Right', gesture:{label,score}, landmarks:[{x,y,z}]}]
  let fsm = { P1:{ primed:false, armed:false }, P2:{ primed:false, armed:false } };
  bus.subscribe('overlay:landmarks', data=>{ hands = data?.hands || []; }, { replay:true });
  bus.subscribe('overlay:fsm', data=>{ fsm = { ...fsm, ...data }; }, { replay:true });

  function draw(){
    const W=g.canvas.width, H=g.canvas.height; g.clearRect(0,0,W,H);
    g.strokeStyle=getComputedStyle(document.body).getPropertyValue('--m3-outline'); g.strokeRect(0,0,W,H);
    const toPx = (pt)=> [ pt.x*W, pt.y*H ];
    hands.forEach((h,idx)=>{
      const state = fsm[h.label] || {};
      // Base hue by handedness, shade by gesture (open vs fist); fallback to FSM colors
      const isLeft = h.handedness === 'Left';
      const isRight = h.handedness === 'Right';
      const glabel = h?.gesture?.label;
      const gscore = typeof h?.gesture?.score === 'number' ? h.gesture.score : 0;
      let color;
      if (isLeft || isRight) {
        if (glabel === 'Open_Palm') {
          color = isLeft ? `rgba(59,130,246,${0.6+0.4*gscore})` : `rgba(147,51,234,${0.6+0.4*gscore})`; // blue or purple
        } else if (glabel === 'Closed_Fist') {
          color = isLeft ? `rgba(34,197,94,${0.6+0.4*gscore})` : `rgba(244,63,94,${0.6+0.4*gscore})`; // green or rose
        } else {
          color = isLeft ? 'rgba(96,165,250,0.9)' : 'rgba(168,85,247,0.9)';
        }
      } else {
        color = state.armed ? 'rgba(34,197,94,1)' : state.primed ? 'rgba(251,191,36,1)' : 'rgba(96,165,250,1)';
      }
      g.fillStyle=color; g.strokeStyle=color;
      (h.landmarks||[]).forEach(pt=>{ const [x,y]=toPx(pt); g.beginPath(); g.arc(x,y,3,0,Math.PI*2); g.fill(); });
    });
    requestAnimationFrame(draw);
  }
  draw();
  </script>
</body>
</html>
