<!doctype html>
<html lang="en">
  <head>
  <!-- WEBWAY:ww-2025-055: v5 demo cloned from v4 with Dino sidecar harness (flagged) -->
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Tectangle — Spatial SDK v5 (Material + Dino Sidecar)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./design/m3.tokens.css" />
    <style>
      html, body { height: 100%; }
      body { background: var(--m3-bg); color: var(--m3-on-surface); }
      canvas { image-rendering: crisp-edges; }
      .card { background: color-mix(in oklab, var(--m3-surface) 88%, black 12%); border: 1px solid var(--m3-outline); border-radius: var(--m3-radius-md); }
      .chip { border-radius: 999px; padding: 2px 8px; border:1px solid var(--m3-outline); font-size: 11px; }
      .btn { border-radius: var(--m3-radius-sm); padding: 6px 10px; font-size: 12px; background: var(--m3-primary); color: white; }
      .toolbar { background: color-mix(in oklab, var(--m3-surface) 80%, black 20%); border: 1px solid var(--m3-outline); border-radius: var(--m3-radius-md); }
    </style>
  </head>
  <body class="h-full">
  <div class="flex h-full">
      <div class="relative flex-1 min-w-0">
  
  <!-- WEBWAY:ww-2025-057: add autoplay to improve headless clip start under tests -->
  <video id="cam" playsinline muted autoplay preload="metadata" class="absolute inset-0 w-full h-full object-cover bg-black"></video>
        <canvas id="overlay" class="absolute inset-0 w-full h-full"></canvas>
        <div class="absolute top-3 left-3 flex flex-wrap items-center gap-2 toolbar backdrop-blur px-2 py-2">
          <button id="btnStart" class="btn">Start Camera</button>
          <button id="btnStop" class="btn" style="background:#ef4444">Stop</button>
          <button id="btnPlayPinch" class="btn" style="background:#3b82f6">Play Pinch</button>
          <button id="btnPlayIdle" class="btn" style="background:#f59e0b">Play Idle</button>
          <button id="btnLaunchDino" class="btn" style="background:#7c3aed" title="Open T-Rex Runner">Launch Dino</button>
          <label class="text-[11px] opacity-80 ml-2">MP4: <input id="fileInput" type="file" accept="video/mp4" class="text-xs" /></label>
          <label class="text-[11px] opacity-80 ml-2 inline-flex items-center gap-1">Fit:
            <select id="fitMode" class="bg-slate-800 text-xs rounded px-1 py-0.5"><option value="cover" selected>cover</option><option value="contain">contain</option></select>
          </label>
          <label class="text-[11px] opacity-80 ml-2 inline-flex items-center gap-1"><input id="mirrorToggle" type="checkbox" class="accent-slate-300"> Mirror</label>
          <span class="chip">Kalman</span>
          <span class="chip" title="Feature-flagged Dino sidecar">Dino</span>
        </div>
        <!-- WEBWAY:ww-2025-056: Floating Dino window scaffold -->
        <div id="dinoWindow" class="hidden" style="position:fixed; top:84px; left:84px; width:520px; height:320px; z-index:1000;">
          <div id="dinoWinChrome" class="flex items-center justify-between px-2 py-1 select-none"
               style="cursor:move; background: color-mix(in oklab, var(--m3-surface) 86%, black 14%); border:1px solid var(--m3-outline); border-bottom:none; border-top-left-radius:8px; border-top-right-radius:8px;">
            <div class="text-[12px] font-semibold">T-Rex Runner <span id="dinoSeatBadge" class="chip ml-2">Seat: P1</span></div>
            <div class="flex items-center gap-1">
              <button id="btnDinoClose" class="chip" title="Close">Close</button>
            </div>
          </div>
          <div id="dinoWinBody" style="background: color-mix(in oklab, var(--m3-surface) 92%, black 8%); border:1px solid var(--m3-outline); border-top:none; border-bottom-left-radius:8px; border-bottom-right-radius:8px; width:100%; height:calc(100% - 30px); display:flex; align-items:stretch;">
            <!-- iframe will be mounted here at runtime -->
          </div>
        </div>
        <!-- Seat Config (flagged) -->
        <div class="absolute right-3 top-3 card p-2 text-[11px] space-y-1" id="seatcfg" style="display:none">
          <div class="font-semibold">Seat Config</div>
          <label class="inline-flex items-center gap-1">Seat
            <select id="cfg_seat" class="bg-slate-800 rounded px-1 py-0.5">
              <option>P1</option><option>P2</option><option>P3</option><option>P4</option>
            </select>
          </label>
          <label class="inline-flex items-center gap-1">Preset
            <select id="cfg_preset" class="bg-slate-800 rounded px-1 py-0.5">
              <option value="responsive">Responsive</option>
              <option value="balanced" selected>Balanced</option>
              <option value="smooth">Smooth</option>
            </select>
          </label>
          <label class="inline-flex items-center gap-1">Lookahead ms <input id="cfg_la" type="number" class="w-16 bg-slate-800 rounded px-1 py-0.5" value="100"/></label>
          <label class="inline-flex items-center gap-1">Enter <input id="cfg_enter" type="number" step="0.01" class="w-16 bg-slate-800 rounded px-1 py-0.5" value="0.50"/></label>
          <label class="inline-flex items-center gap-1">Exit <input id="cfg_exit" type="number" step="0.01" class="w-16 bg-slate-800 rounded px-1 py-0.5" value="0.80"/></label>
          <label class="inline-flex items-center gap-1">Anchor ms <input id="cfg_anchor" type="number" class="w-16 bg-slate-800 rounded px-1 py-0.5" value="75"/></label>
          <label class="inline-flex items-center gap-1">Knuckle cm <input id="cfg_knuckle" type="number" step="0.1" class="w-16 bg-slate-800 rounded px-1 py-0.5" value="8.0"/></label>
          <button id="cfg_apply" class="btn">Apply</button>
        </div>
        <!-- Predictive Lookahead (Kalman) tray -->
        <div class="absolute left-3 right-3 bottom-3 space-y-2" id="kalman-mount">
          <div id="kalman" class="card p-2 text-[11px]">
            <div class="flex items-center justify-between mb-1">
              <div class="font-semibold">Predictive Lookahead (1D Kalman)</div>
              <div class="flex items-center gap-2 opacity-80">
                <label class="inline-flex items-center gap-1">lookahead ms <input id="la" type="number" step="5" value="100" class="w-16 bg-slate-800 rounded px-1 py-0.5"/></label>
                <label class="inline-flex items-center gap-1">Q <input id="q" type="number" step="0.0001" value="0.01" class="w-20 bg-slate-800 rounded px-1 py-0.5"/></label>
                <label class="inline-flex items-center gap-1">R <input id="r" type="number" step="0.0001" value="0.001" class="w-20 bg-slate-800 rounded px-1 py-0.5"/></label>
              </div>
            </div>
            <div id="strips" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
          </div>
        </div>
      </div>
  <aside id="panel" class="w-[360px] max-w-full border-l border-slate-800 bg-slate-950/70 backdrop-blur-md overflow-auto">
        <div class="p-3 flex items-center justify-between sticky top-0 bg-slate-950/90 border-b border-slate-800">
          <h2 class="font-semibold">Side Panel (v5)</h2>
          <span class="chip">Live</span>
        </div>
        <div class="p-3 space-y-3">
          <!-- WEBWAY:ww-2025-059: E2E ready sentinel (hidden) -->
          <div id="e2eReady" data-ready="0" style="display:none">0</div>
          <div><h3 class="text-sm font-semibold mb-1">State</h3><pre id="state" class="text-xs whitespace-pre-wrap bg-slate-900 p-2 rounded border border-slate-800"></pre></div>
          <div><h3 class="text-sm font-semibold mb-1">Last Frame (rich)</h3><pre id="rich" class="text-xs whitespace-pre-wrap bg-slate-900 p-2 rounded border border-slate-800"></pre></div>
          <div>
            <h3 class="text-sm font-semibold mb-1">Dino</h3>
            <div class="text-[11px] opacity-80 mb-1">Opens official BSD-3 T-Rex Runner and wires Space via sidecar.</div>
            <!-- WEBWAY:ww-2025-056: iframe docks here when window closed -->
            <div id="dinoDock" style="width:100%;height:auto;"></div>
            <iframe id="dino" title="T-Rex Runner" style="width:100%;height:240px;border:1px solid var(--m3-outline);border-radius:8px;background:#0c1117; display:none"></iframe>
          </div>
        </div>
      </aside>
    </div>
    <script type="module">
      // WEBWAY:ww-2025-055: v5 page derives from v4 and attaches Dino sidecar behind flag/URL
      import { createSpatialInput, createTTIRecorder } from '../../../src/index.js';
      import { createAppShell } from '../src/app/appShell.js';
      import { createToiKalmanCV } from '../src/ports/toiKalmanPort.js';
      import { createGuards } from './src/ui/guards.js';
      import { createHandOverlay } from './src/overlay/hand_overlay.js';
      // WEBWAY:ww-2025-055: sidecar adapter
      import { createDinoSidecar } from './sidecars/dino_sidecar.mjs';

      const video=document.getElementById('cam'); const canvas=document.getElementById('overlay'); const ctx=canvas.getContext('2d');
  const btnStart=document.getElementById('btnStart'); const btnStop=document.getElementById('btnStop');
  const btnLaunchDino=document.getElementById('btnLaunchDino');
      
      const btnPlayPinch=document.getElementById('btnPlayPinch'); const btnPlayIdle=document.getElementById('btnPlayIdle'); const fileInput=document.getElementById('fileInput');
      const elState=document.getElementById('state'); const elRich=document.getElementById('rich');
      const fitMode=document.getElementById('fitMode'); const mirrorToggle=document.getElementById('mirrorToggle');

      const guards = createGuards({ mount: document });
      guards.apply('#btnStart', 'ready'); guards.apply('#btnStop', 'ready'); guards.apply('#btnPlayPinch', 'ready'); guards.apply('#btnPlayIdle', 'ready');
      guards.apply('#fitMode', 'ready'); guards.apply('#mirrorToggle', 'ready');

      const sdk=createSpatialInput({ factories:{ createAppShell } }); window.__sdk=sdk;
  const tti = createTTIRecorder({ getLookaheadMs: ()=> +laEl?.value || 0 }); window.__tti = tti;
      
      const pinchTelem = (await import('./src/telemetry/pinch_telemetry.js')).createPinchTelemetry?.(); window.__pinchTelem = pinchTelem;
      // WEBWAY:ww-2025-057: optional autoplay + pinch probe (flagged)
      (function installProbe(){ try{
        if(!window.__flags || !window.__flags['FEATURE_V5_AUTOPLAY_PROBE']) return;
        window.__probe = window.__probe || { downs:0, ups:0, started:false, mp:'pending' };
        // WEBWAY:ww-2025-061: mark probe started on install and on first event
        window.__probe.started = true;
        try{ sdk.on((e)=>{ 
          if(!window.__probe.started) window.__probe.started = true;
          if(e?.type==='pinch:down') window.__probe.downs++; else if(e?.type==='pinch:up') window.__probe.ups++; 
        }); }catch{}
        console.log('WEBWAY:ww-2025-057: probe installed');
      }catch{}})();

      function fitCanvas(){ const rect=canvas.getBoundingClientRect(); canvas.width=Math.max(2,Math.floor(rect.width)); canvas.height=Math.max(2,Math.floor(rect.height)); }
      const ro=new ResizeObserver(fitCanvas); ro.observe(canvas); fitCanvas();
      fitMode.addEventListener('change',()=>{ video.style.objectFit=fitMode.value; });
      mirrorToggle.addEventListener('change',()=>{ const on=!!mirrorToggle.checked; video.style.transform=on?'scaleX(-1)':'none'; });

      const kalmanMap = new Map();
      const laEl = document.getElementById('la'); const qEl = document.getElementById('q'); const rEl = document.getElementById('r');
      function getKalman(handKey){ let k = kalmanMap.get(handKey); if(!k){ k = createToiKalmanCV({ q:+qEl.value||0.01, r:+rEl.value||0.001 }); kalmanMap.set(handKey,k); } return k; }
      function resetAllKalman(){ for(const k of kalmanMap.values()) k.reset(); }
      qEl?.addEventListener('change', ()=>{ for(const k of kalmanMap.values()) k.setParams({ q:+qEl.value||0.01 }); });
      rEl?.addEventListener('change', ()=>{ for(const k of kalmanMap.values()) k.setParams({ r:+rEl.value||0.001 }); });

      const stripsEl=document.getElementById('strips');
      const overlay = createHandOverlay({
        canvas,
        video,
        sdk,
        getFitMode: ()=> fitMode.value,
        getMirrored: ()=> !!mirrorToggle.checked,
      });
  // WEBWAY:ww-2025-058: unify seat resolve across UI (state map -> rich -> heuristic)
  function seatFromState(state, snap){ try{
    const map = state?.seats?.map; if(!Array.isArray(map)) return undefined;
    // map is an array of [ [handKey, seat], ... ]
    const handKey = snap?.hand ? `hand:${snap.hand}` : null; if(!handKey) return undefined;
    for(const entry of map){ const k = Array.isArray(entry) ? entry[0] : null; const v = Array.isArray(entry) ? entry[1] : null; if(k===handKey && typeof v==='string') return v; }
    return undefined;
  }catch{ return undefined; }}
  // WEBWAY:ww-2025-056: ensureStrip uses seat-first labels
  function ensureStrip(handKey,label){ let row=document.querySelector(`[data-strip="${handKey}"]`); if(!row){ row=document.createElement('div'); row.dataset.strip=handKey; row.className='space-y-1'; row.innerHTML=`<div class="flex items-center justify-between"><div class="font-semibold text-[11px]">${label}</div><div class="text-[10px] opacity-70" data-state></div></div><div class="relative h-6 bg-slate-800/60 rounded overflow-hidden" data-bar><div class="absolute top-0 bottom-0 bg-emerald-500/20" data-enter></div><div class="absolute top-0 bottom-0 bg-rose-500/20" data-exit></div><div class="absolute top-0 bottom-0" data-dot style="width:2px;background:#fff"></div><div class="absolute top-0 bottom-0" data-ghost style="width:2px;background:#22d3ee"></div><canvas data-spark class="absolute inset-0"></canvas></div>`; stripsEl.appendChild(row);} return row; }
      function renderStrip(row, snap, ghost){ const bar=row.querySelector('[data-bar]'); const spark=row.querySelector('[data-spark]'); const dot=row.querySelector('[data-dot]'); const ghostEl=row.querySelector('[data-ghost]'); const st=row.querySelector('[data-state]'); const W=bar.clientWidth||200, H=bar.clientHeight||24; 
        const enterPct=(snap?.thresholds?.enter ?? 0.5); const exitPct=(snap?.thresholds?.exit ?? 0.8); const enterEl=row.querySelector('[data-enter]'); const exitEl=row.querySelector('[data-exit]'); enterEl.style.left='0%'; enterEl.style.width=(enterPct*100)+'%'; exitEl.style.left='0%'; exitEl.style.width=(exitPct*100)+'%';
        const norm = (snap?.norm!=null)? snap.norm : null; if(norm!=null){ dot.style.left = (norm*100)+'%'; }
        if(ghost!=null){ ghostEl.style.left = (Math.max(0,Math.min(1,ghost))*100)+'%'; ghostEl.style.display='block'; } else { ghostEl.style.display='none'; }
        let fsm = snap?.fsm || (snap?.gate===false?'GATED':(norm!=null? (norm<enterPct?'Armed': (norm<exitPct?'Held':'Released')):'?'));
        st.textContent = `${fsm}${snap?.palmAngleDeg!=null? ' | palm '+snap.palmAngleDeg.toFixed(0)+'°':''}`;
        const hist = Array.isArray(snap?.history)? snap.history : []; spark.width=W; spark.height=H; const sctx=spark.getContext('2d'); sctx.clearRect(0,0,W,H);
        if(hist.length){ sctx.strokeStyle='#94a3b8'; sctx.lineWidth=1; sctx.beginPath(); for(let i=0;i<hist.length;i++){ const x = (i/(hist.length-1))*W; const y = H - (hist[i].norm!=null? hist[i].norm:0)*H; if(i===0) sctx.moveTo(x,y); else sctx.lineTo(x,y); } sctx.stroke(); }
      }

      function updateReady() { try{
        const el = document.getElementById('e2eReady'); if(!el) return;
        const stripCount = Object.keys((window.__diag && window.__diag.strips) || {}).length;
        const richFrames = (window.__diag && window.__diag.richFrames) || 0;
        const vidReady = (video && typeof video.readyState==='number' && video.readyState >= 2 /* HAVE_CURRENT_DATA */);
        const hasTime = (video && +video.currentTime > 0);
        const probeArmed = (!!window.__probe || !((window.__flags||{}).FEATURE_V5_READY_SENTINEL));
        // WEBWAY:ww-2025-061: stricter ready only when flag on; otherwise preserve lenient behavior
        const strict = (window.__flags && window.__flags['FEATURE_V5_READY_SENTINEL']);
        let ok;
        if(strict){
          ok = (vidReady && hasTime && richFrames >= 3 && stripCount > 0 && probeArmed);
        } else {
          ok = (richFrames >= 3 && stripCount > 0);
        }
        const ready = ok ? '1' : '0';
        el.dataset.ready = ready; el.textContent = ready;
      }catch{} }

  function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); const state=sdk.getState?.()||{}; const rich=sdk.getRichSnapshot?.()||[];
        window.__diag = window.__diag || { richFrames:0, strips:{}, seatsRich:[] };
        try{ overlay.draw(); }catch{}
        const now = performance.now();
        if (Array.isArray(rich) && rich.length) { window.__diag.richFrames = (window.__diag.richFrames||0) + 1; }
        for(const snap of rich){ if(snap?.norm==null) continue; const handKey = snap.hand + ':' + (snap.handId ?? '?');
          const seat = (snap.seat ?? seatFromState(state, snap) ?? seatFromHand(snap.hand) ?? '?');
          const row=ensureStrip(handKey, `${seat}${seat==='?'?'':''}`);
          try{ window.__diag.strips[handKey] = seat; window.__diag.seatsRich.push(snap.seat||seat); }catch{}
          const k = getKalman(handKey); const r = k.step({ t: now, norm: snap.norm, enterThresh: (snap?.thresholds?.enter ?? 0.5) });
          const dtAhead = Math.max(0, (+laEl?.value||0)/1000);
          const ghost = r.x + r.v * dtAhead;
          renderStrip(row, snap, ghost);
          try{ tti.update({ now, handKey, snap, kalman: r, enterThresh: (snap?.thresholds?.enter ?? 0.5) }); }catch{}
        }
        updateReady();
      }
      function scheduleDraw(){
        // WEBWAY:ww-2025-059: dual scheduler — rVFC when frames are flowing, plus a gentle rAF as a kick for test readiness
        if('requestVideoFrameCallback' in video){
          const cb=()=>{ try{draw();}catch(e){}; try{ video.requestVideoFrameCallback(cb);}catch{ requestAnimationFrame(scheduleDraw);} };
          try{ video.requestVideoFrameCallback(cb);}catch{ requestAnimationFrame(scheduleDraw);} 
        }
        // Always keep a lightweight rAF loop as a safety net for tests (does little work until rich has data)
        (function rafKick(){ draw(); requestAnimationFrame(rafKick); })();
      }
      scheduleDraw();

      // Live panel text updates
      // WEBWAY:ww-2025-056: Throttle and trim rich panel to avoid scroll spam
      setInterval(()=>{ try{
        const st=sdk.getState?.(); if(st) elState.textContent = JSON.stringify(st, null, 2);
        const rich=sdk.getRichSnapshot?.();
        if(Array.isArray(rich)){
          const last = rich.slice(-24).map(s=>({ seat: s.seat||seatFromHand(s.hand), norm: +(s.norm??0).toFixed(3), fsm: s.fsm||undefined }));
          elRich.textContent = JSON.stringify(last, null, 2);
        }
      }catch{} }, 1000);

      // Controls
      btnStart.addEventListener('click', async()=>{ try{ await sdk.startCamera(video);}catch(e){ console.error(e);} });
  btnStop.addEventListener('click', ()=>{ sdk.stop(video); resetAllKalman(); });
  
  // WEBWAY:ww-2025-057: nudge autoplay after SDK startVideoUrl
  async function playUrl(url){ try{ try{ video.crossOrigin='anonymous'; }catch{} await sdk.startVideoUrl(video,url); setTimeout(()=>{ try{ video.muted=true; video.play&&video.play().catch(()=>{}); }catch{} }, 50); }catch(e){ console.error('Failed to play url',url,e);} }
      const PINCH_URL='/September2025/TectangleHexagonal/videos/golden/golden.two_hands_pinch_seq.v1.mp4'; const IDLE_URL='/September2025/TectangleHexagonal/videos/golden/golden.two_hands_idle.v1.mp4';
      btnPlayPinch.addEventListener('click', ()=> playUrl(PINCH_URL)); btnPlayIdle.addEventListener('click', ()=> playUrl(IDLE_URL));
      fileInput.addEventListener('change', async (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const blobUrl=URL.createObjectURL(f); await playUrl(blobUrl); });

      // WEBWAY:ww-2025-055: Dino sidecar attach (feature-flagged)
      const dinoFrame = document.getElementById('dino');
      const dinoDock = document.getElementById('dinoDock');
      const dinoWindow = document.getElementById('dinoWindow');
      const dinoWinBody = document.getElementById('dinoWinBody');
      const dinoWinChrome = document.getElementById('dinoWinChrome');
      const btnDinoClose = document.getElementById('btnDinoClose');
  const dino = createDinoSidecar({ target: window });
  let dinoSeat = 'P1';
      window.__dino = dino; // for e2e summary
      // WEBWAY:ww-2025-056: Floating window open/close + drag + focus
      function mountIframeInto(target){
        if(!dinoFrame || !target) return;
        try{ target.appendChild(dinoFrame); }catch{}
      }
      function showDinoWindow(){
        if(!dinoWindow) return;
        dinoWindow.classList.remove('hidden');
        mountIframeInto(dinoWinBody);
      }
      function hideDinoWindow(){
        if(!dinoWindow) return;
        dinoWindow.classList.add('hidden');
        mountIframeInto(dinoDock);
        try{ dinoFrame.style.display='none'; }catch{}
      }
      btnDinoClose?.addEventListener('click', hideDinoWindow);

      // Basic dragging via header
      (function enableDrag(){
        let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;
        function onMove(e){ if(!dragging) return; const dx=(e.clientX-startX), dy=(e.clientY-startY); dinoWindow.style.left=(startLeft+dx)+"px"; dinoWindow.style.top=(startTop+dy)+"px"; }
        function onUp(){ dragging=false; window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); }
        dinoWinChrome?.addEventListener('mousedown', (e)=>{ if(!dinoWindow) return; dragging=true; startX=e.clientX; startY=e.clientY; const rect=dinoWindow.getBoundingClientRect(); startLeft=rect.left; startTop=rect.top; window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp); });
      })();

      // Extract wiring so we can reuse for auto-dock and launch window
      function configureDinoBridge(w){
        if(!w) return;
        dino.setParams({ target: w, code: 'Space', key: ' ', seat: dinoSeat || 'P1' });
        try{
          // WEBWAY:ww-2025-060: add echo counter and postMessage back to parent for e2e assertions
          w.__dinoEcho = 0; // number of keydown space injections observed
          w.addEventListener('message', (ev)=>{
            const msg = ev && ev.data; if(!msg || msg.type!=='dino:key') return;
            const type = msg.action === 'down' ? 'keydown' : 'keyup';
            const init = { code: 'Space', key: ' ', bubbles: true, cancelable: true, keyCode: 32, which: 32 };
            const Evt = w.KeyboardEvent || KeyboardEvent;
            const kev = new Evt(type, init);
            try { Object.defineProperty(kev, 'keyCode', { get: ()=>32 }); } catch {}
            try { Object.defineProperty(kev, 'which', { get: ()=>32 }); } catch {}
            const doc = w.document;
            try{ doc && doc.dispatchEvent && doc.dispatchEvent(kev); }catch{}
            try{ w && w.dispatchEvent && w.dispatchEvent(kev); }catch{}
            try{ const canvas = doc && doc.querySelector && doc.querySelector('canvas'); if(canvas) canvas.dispatchEvent(kev); }catch{}
            if(type==='keydown'){
              try{ w.__dinoEcho = (w.__dinoEcho||0) + 1; }catch{}
              try{ window.postMessage({ type:'dino:echo', count: w.__dinoEcho }, '*'); }catch{}
            }
          });
        }catch{}
        // Nudge focus and user-gesture: click canvas if present
        try{ const doc=w.document; const canvas=doc?.querySelector('canvas'); canvas?.focus?.(); canvas?.click?.(); w.focus?.(); }catch{}
        // WEBWAY:ww-2025-060: focus/click retries until echo is observed or attempts exhausted
        try{
          let tries=0; const max=24; // ~6s at 250ms
          const iv = setInterval(()=>{
            try{
              if((w.__dinoEcho||0) > 0 || tries>=max){ clearInterval(iv); return; }
              const doc=w.document; const canvas=doc?.querySelector('canvas');
              canvas?.focus?.(); canvas?.click?.(); w.focus?.();
              tries++;
            }catch{ clearInterval(iv); }
          }, 250);
        }catch{}
      }

      function launchDino(){
        try{
          if(!dinoFrame) return;
          showDinoWindow();
          dinoFrame.src = '../vendor/dino/index.html';
          dinoFrame.style.display='block';
          dinoFrame.onload = ()=>{
            try{ configureDinoBridge(dinoFrame.contentWindow); }catch{}
          };
        }catch{}
      }
  btnLaunchDino?.addEventListener('click', launchDino);

      // URL params for automation
      (async function autoStartFromQuery(){
        try{
          window.__flags = window.__flags || {};
          const p = new URLSearchParams(location.search);
          const clip = p.get('clip'); const autostart = p.get('autostart')==='1';
          if(p.has('la')){ const v = String(+p.get('la')); const el=document.getElementById('la'); if(el) el.value=v; }
          if(p.has('q')){ const v = String(+p.get('q')); const el=document.getElementById('q'); if(el){ el.value=v; for(const k of kalmanMap.values()) k.setParams({ q:+v||0.01 }); } }
          if(p.has('r')){ const v = String(+p.get('r')); const el=document.getElementById('r'); if(el){ el.value=v; for(const k of kalmanMap.values()) k.setParams({ r:+v||0.001 }); } }
          if(p.get('seatcfg')==='1'){ window.__flags['FEATURE_SEAT_CONFIG']=true; const box=document.getElementById('seatcfg'); if(box) box.style.display='block'; }
          // WEBWAY:ww-2025-057: enable autoplay/pinch probe via query
          if(p.get('probe')==='1'){ window.__flags['FEATURE_V5_AUTOPLAY_PROBE']=true; console.log('WEBWAY:ww-2025-057: probe flag on'); }
          // WEBWAY:ww-2025-059: enable ready sentinel helpers for tests
          if(p.get('forceRaf')==='1'){ window.__flags['FEATURE_V5_READY_SENTINEL']=true; console.log('WEBWAY:ww-2025-059: ready-sentinel on'); }
          if(p.has('seat')){ dinoSeat = (p.get('seat')||'P1').toUpperCase(); }
          if(p.get('dino')==='1'){
            window.__flags['FEATURE_SIDECAR_DINO_V5']=true; dino.attach({ sdk });
            // Auto-dock Dino when not explicitly launched, so sidecar has a live target
            if(dinoFrame && !p.get('launch')){
              try{
                // Mount into dock and load src; keep visible inside side panel
                mountIframeInto(dinoDock);
                dinoFrame.src = '../vendor/dino/index.html';
                dinoFrame.style.display='block';
                // WEBWAY:ww-2025-081: optional semi-transparency for better video visibility
                if(p.get('semi')==='1' || (window.__flags && window.__flags['FEATURE_DINO_SEMITRANSPARENT'])){
                  try{ dinoFrame.style.opacity = '0.6'; }catch{}
                }
                dinoFrame.onload = ()=>{ try{ configureDinoBridge(dinoFrame.contentWindow); }catch{} };
              }catch{}
            }
          }
          if(p.get('launch')==='1'){ launchDino(); }
          if(autostart && clip){ try{ video.muted=true; video.autoplay=true; }catch{}; await playUrl(clip); }
          // WEBWAY:ww-2025-081: Dino autolaunch via flag (v5 footing)
          if(window.__flags['FEATURE_V5_DINO_AUTOLAUNCH'] && !p.get('dino')){
            try{
              window.__flags['FEATURE_SIDECAR_DINO_V5']=true; dino.attach({ sdk });
              mountIframeInto(dinoDock);
              dinoFrame.src = '../vendor/dino/index.html';
              dinoFrame.style.display='block';
              if(window.__flags['FEATURE_DINO_SEMITRANSPARENT']){ try{ dinoFrame.style.opacity = '0.6'; }catch{} }
              dinoFrame.onload = ()=>{ try{ configureDinoBridge(dinoFrame.contentWindow); }catch{} };
            }catch{}
          }
        }catch(e){ console.warn('autostart params failed', e); }
      })();

      // WEBWAY:ww-2025-060: Parent listens for echo count updates for diagnostics
      try{
        window.addEventListener('message', (ev)=>{
          try{
            const d = ev && ev.data; if(!d || d.type!=='dino:echo') return;
            window.__diag = window.__diag || {}; window.__diag.dinoEcho = d.count;
          }catch{}
        });
      }catch{}

      // WEBWAY:ww-2025-056: prefer seat-first labeling with fallback
      function seatFromHand(hand){ if(!hand) return undefined; const h = String(hand).toLowerCase(); if(h.startsWith('l')) return 'P1'; if(h.startsWith('r')) return 'P2'; return undefined; }
    </script>
  </body>
  </html>
