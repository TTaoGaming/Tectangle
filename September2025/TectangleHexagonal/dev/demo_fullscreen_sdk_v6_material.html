<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Tectangle — Spatial SDK v6 (Material + P1/P2 Lock-In)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./design/m3.tokens.css" />
    <style>
      html, body { height: 100%; }
      body { background: var(--m3-bg); color: var(--m3-on-surface); }
      canvas { image-rendering: crisp-edges; }
      .card { background: color-mix(in oklab, var(--m3-surface) 88%, black 12%); border: 1px solid var(--m3-outline); border-radius: var(--m3-radius-md); }
      .chip { border-radius: 999px; padding: 2px 8px; border:1px solid var(--m3-outline); font-size: 11px; }
      .btn { border-radius: var(--m3-radius-sm); padding: 6px 10px; font-size: 12px; background: var(--m3-primary); color: white; }
      .toolbar { background: color-mix(in oklab, var(--m3-surface) 80%, black 20%); border: 1px solid var(--m3-outline); border-radius: var(--m3-radius-md); }
    </style>
  </head>
  <body class="h-full">
    <div class="flex h-full">
      <div class="relative flex-1 min-w-0">
        <video id="cam" playsinline muted autoplay preload="metadata" class="absolute inset-0 w-full h-full object-cover bg-black"></video>
        <canvas id="overlay" class="absolute inset-0 w-full h-full"></canvas>
        <div class="absolute top-3 left-3 flex flex-wrap items-center gap-2 toolbar backdrop-blur px-2 py-2">
          <button id="btnStart" class="btn">Start Camera</button>
          <button id="btnStop" class="btn" style="background:#ef4444">Stop</button>
          <button id="btnPlayPinch" class="btn" style="background:#3b82f6">Play Pinch</button>
          <button id="btnPlayIdle" class="btn" style="background:#f59e0b">Play Idle</button>
          <label class="text-[11px] opacity-80 ml-2">MP4: <input id="fileInput" type="file" accept="video/mp4" class="text-xs" /></label>
          <label class="text-[11px] opacity-80 ml-2 inline-flex items-center gap-1">Fit:
            <select id="fitMode" class="bg-slate-800 text-xs rounded px-1 py-0.5"><option value="cover" selected>cover</option><option value="contain">contain</option></select>
          </label>
          <label class="text-[11px] opacity-80 ml-2 inline-flex items-center gap-1"><input id="mirrorToggle" type="checkbox" class="accent-slate-300"> Mirror</label>
          <span class="chip">Kalman</span>
          <span class="chip" title="P1/P2 lock-in">Lock-In</span>
        </div>
        <!-- Seat Config (for tuning, optional) -->
        <div class="absolute right-3 top-3 card p-2 text-[11px] space-y-1" id="seatcfg" style="display:none">
          <div class="font-semibold">Seat Config</div>
          <label class="inline-flex items-center gap-1">Preset
            <select id="cfg_preset" class="bg-slate-800 rounded px-1 py-0.5">
              <option value="balanced" selected>Balanced</option>
              <option value="smooth">Smooth</option>
              <option value="responsive">Responsive</option>
            </select>
          </label>
          <label class="inline-flex items-center gap-1">Lookahead ms <input id="cfg_la" type="number" class="w-16 bg-slate-800 rounded px-1 py-0.5" value="100"/></label>
          <label class="inline-flex items-center gap-1">Enter <input id="cfg_enter" type="number" step="0.01" class="w-16 bg-slate-800 rounded px-1 py-0.5" value="0.50"/></label>
          <label class="inline-flex items-center gap-1">Exit <input id="cfg_exit" type="number" step="0.01" class="w-16 bg-slate-800 rounded px-1 py-0.5" value="0.80"/></label>
          <button id="cfg_apply" class="btn">Apply</button>
        </div>

  <!-- Lock-In HUD (shifted up, hidden by default; enable with ?hud=1) -->
  <div class="absolute left-3 right-3 grid grid-cols-2 gap-2" id="lockHud" style="bottom: 168px; display:none;">
          <div class="card p-2 text-[12px]">
            <div class="flex items-center justify-between mb-1"><div class="font-semibold">P1</div><div class="chip" id="p1Badge">–</div></div>
            <pre id="p1Log" class="text-xs bg-slate-900 p-2 rounded border border-slate-800 h-24 overflow-auto"></pre>
          </div>
          <div class="card p-2 text-[12px]">
            <div class="flex items-center justify-between mb-1"><div class="font-semibold">P2</div><div class="chip" id="p2Badge">–</div></div>
            <pre id="p2Log" class="text-xs bg-slate-900 p-2 rounded border border-slate-800 h-24 overflow-auto"></pre>
          </div>
        </div>
        <!-- Predictive Lookahead (1D Kalman) tray -->
        <div class="absolute left-3 right-3 bottom-3 space-y-2" id="kalman-mount">
          <div id="kalman" class="card p-2 text-[11px]">
            <div class="flex items-center justify-between mb-1">
              <div class="font-semibold">Predictive Lookahead (1D Kalman)</div>
              <div class="flex items-center gap-2 opacity-80">
                <label class="inline-flex items-center gap-1">lookahead ms <input id="la" type="number" step="5" value="100" class="w-16 bg-slate-800 rounded px-1 py-0.5"/></label>
                <label class="inline-flex items-center gap-1">Q <input id="q" type="number" step="0.0001" value="0.01" class="w-20 bg-slate-800 rounded px-1 py-0.5"/></label>
                <label class="inline-flex items-center gap-1">R <input id="r" type="number" step="0.0001" value="0.001" class="w-20 bg-slate-800 rounded px-1 py-0.5"/></label>
              </div>
            </div>
            <div id="strips" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
          </div>
        </div>
      </div>
      <aside id="panel" class="w-[360px] max-w-full border-l border-slate-800 bg-slate-950/70 backdrop-blur-md overflow-auto">
        <div class="p-3 flex items-center justify-between sticky top-0 bg-slate-950/90 border-b border-slate-800">
          <h2 class="font-semibold">Side Panel (v6)</h2>
          <span class="chip">Live</span>
        </div>
        <div class="p-3 space-y-3">
          <div id="e2eReady" data-ready="0" style="display:none">0</div>
          <!-- WEBWAY:ww-2025-062: Seat Cards (toggle via ?panel_card=1) -->
          <div id="seatCards" class="space-y-2" style="display:none">
            <div class="card p-2">
              <div class="flex items-center justify-between mb-1">
                <div class="font-semibold">P1</div>
                <span class="chip" id="p1CardBadge">–</span>
              </div>
              <div class="grid grid-cols-2 gap-x-2 text-[11px] opacity-90">
                <div class="opacity-70">Hand</div><div id="p1CardHand">–</div>
                <div class="opacity-70">State</div><div id="p1CardFsm">–</div>
                <div class="opacity-70">Norm</div><div id="p1CardNorm">–</div>
              </div>
            </div>
            <div class="card p-2">
              <div class="flex items-center justify-between mb-1">
                <div class="font-semibold">P2</div>
                <span class="chip" id="p2CardBadge">–</span>
              </div>
              <div class="grid grid-cols-2 gap-x-2 text-[11px] opacity-90">
                <div class="opacity-70">Hand</div><div id="p2CardHand">–</div>
                <div class="opacity-70">State</div><div id="p2CardFsm">–</div>
                <div class="opacity-70">Norm</div><div id="p2CardNorm">–</div>
              </div>
            </div>
          </div>
          <!-- Legacy debug (hidden when panel_card=1) -->
          <div id="legacyPanelBlocks">
            <div><h3 class="text-sm font-semibold mb-1">State</h3><pre id="state" class="text-xs whitespace-pre-wrap bg-slate-900 p-2 rounded border border-slate-800"></pre></div>
            <div><h3 class="text-sm font-semibold mb-1">Last Frame (rich)</h3><pre id="rich" class="text-xs whitespace-pre-wrap bg-slate-900 p-2 rounded border border-slate-800"></pre></div>
          </div>
        </div>
      </aside>
    </div>
    <script type="module">
      import { createSpatialInput, createTTIRecorder } from '../../../src/index.js';
      import { createAppShell } from '../src/app/appShell.js';
  import { createToiKalmanCV } from '../src/ports/toiKalmanPort.js';
  import { createHandOverlay } from './src/overlay/hand_overlay.js';
      import { createDinoSidecar } from './sidecars/dino_sidecar.mjs';

      const video=document.getElementById('cam'); const canvas=document.getElementById('overlay'); const ctx=canvas.getContext('2d');
      const btnStart=document.getElementById('btnStart'); const btnStop=document.getElementById('btnStop');
      const btnPlayPinch=document.getElementById('btnPlayPinch'); const btnPlayIdle=document.getElementById('btnPlayIdle'); const fileInput=document.getElementById('fileInput');
  const elState=document.getElementById('state'); const elRich=document.getElementById('rich');
  const seatCards=document.getElementById('seatCards'); const legacyPanelBlocks=document.getElementById('legacyPanelBlocks');
  const p1Card={ badge:document.getElementById('p1CardBadge'), hand:document.getElementById('p1CardHand'), fsm:document.getElementById('p1CardFsm'), norm:document.getElementById('p1CardNorm') };
  const p2Card={ badge:document.getElementById('p2CardBadge'), hand:document.getElementById('p2CardHand'), fsm:document.getElementById('p2CardFsm'), norm:document.getElementById('p2CardNorm') };
      const fitMode=document.getElementById('fitMode'); const mirrorToggle=document.getElementById('mirrorToggle');
      const p1Badge=document.getElementById('p1Badge'); const p2Badge=document.getElementById('p2Badge');
      const p1Log=document.getElementById('p1Log'); const p2Log=document.getElementById('p2Log');

  const sdk=createSpatialInput({ factories:{ createAppShell } });
      window.__sdk=sdk;
      const tti = createTTIRecorder({ getLookaheadMs: ()=> 0 });

      function fitCanvas(){ const rect=canvas.getBoundingClientRect(); canvas.width=Math.max(2,Math.floor(rect.width)); canvas.height=Math.max(2,Math.floor(rect.height)); }
      const ro=new ResizeObserver(fitCanvas); ro.observe(canvas); fitCanvas();
      fitMode.addEventListener('change',()=>{ video.style.objectFit=fitMode.value; });
      mirrorToggle.addEventListener('change',()=>{ const on=!!mirrorToggle.checked; video.style.transform=on?'scaleX(-1)':'none'; });

  const kalmanMap = new Map();
  const laEl = document.getElementById('la'); const qEl = document.getElementById('q'); const rEl = document.getElementById('r');
  function getKalman(handKey){ let k = kalmanMap.get(handKey); if(!k){ k = createToiKalmanCV({ q:+(qEl?.value||0.01), r:+(rEl?.value||0.001) }); kalmanMap.set(handKey,k); } return k; }
  function resetAllKalman(){ for(const k of kalmanMap.values()) k.reset(); }
  qEl?.addEventListener('change', ()=>{ for(const k of kalmanMap.values()) k.setParams({ q:+(qEl?.value||0.01) }); });
  rEl?.addEventListener('change', ()=>{ for(const k of kalmanMap.values()) k.setParams({ r:+(rEl?.value||0.001) }); });

      // Minimal seat view
      function seatFromHand(hand){ if(!hand) return undefined; const h = String(hand).toLowerCase(); if(h.startsWith('l')) return 'P1'; if(h.startsWith('r')) return 'P2'; return undefined; }
      // v5-style seat resolution from state map
      function seatFromState(state, snap){ try{
        const map = state?.seats?.map; if(!Array.isArray(map)) return undefined;
        const handKey = snap?.hand ? `hand:${snap.hand}` : null; if(!handKey) return undefined;
        for(const entry of map){ const k = Array.isArray(entry) ? entry[0] : null; const v = Array.isArray(entry) ? entry[1] : null; if(k===handKey && typeof v==='string') return v; }
        return undefined;
      }catch{ return undefined; } }

      // Hand overlay and hysteresis strips
      const overlay = createHandOverlay({
        canvas,
        video,
        sdk,
        getFitMode: ()=> fitMode.value,
        getMirrored: ()=> !!mirrorToggle.checked,
      });
      const stripsEl = document.getElementById('strips');
      function ensureStrip(handKey,label){ let row=document.querySelector(`[data-strip="${handKey}"]`); if(!row){ row=document.createElement('div'); row.dataset.strip=handKey; row.className='space-y-1'; row.innerHTML=`<div class=\"flex items-center justify-between\"><div class=\"font-semibold text-[11px]\">${label}</div><div class=\"text-[10px] opacity-70\" data-state></div></div><div class=\"relative h-6 bg-slate-800/60 rounded overflow-hidden\" data-bar><div class=\"absolute top-0 bottom-0 bg-emerald-500/20\" data-enter></div><div class=\"absolute top-0 bottom-0 bg-rose-500/20\" data-exit></div><div class=\"absolute top-0 bottom-0\" data-dot style=\"width:2px;background:#fff\"></div><div class=\"absolute top-0 bottom-0\" data-ghost style=\"width:2px;background:#22d3ee\"></div><canvas data-spark class=\"absolute inset-0\"></canvas></div>`; stripsEl.appendChild(row);} return row; }
      function renderStrip(row, snap, ghost){ const bar=row.querySelector('[data-bar]'); const spark=row.querySelector('[data-spark]'); const dot=row.querySelector('[data-dot]'); const ghostEl=row.querySelector('[data-ghost]'); const st=row.querySelector('[data-state]'); const W=bar.clientWidth||200, H=bar.clientHeight||24; 
        const enterPct=(snap?.thresholds?.enter ?? 0.5); const exitPct=(snap?.thresholds?.exit ?? 0.8); const enterEl=row.querySelector('[data-enter]'); const exitEl=row.querySelector('[data-exit]'); enterEl.style.left='0%'; enterEl.style.width=(enterPct*100)+'%'; exitEl.style.left='0%'; exitEl.style.width=(exitPct*100)+'%';
        const norm = (snap?.norm!=null)? snap.norm : null; if(norm!=null){ dot.style.left = (norm*100)+'%'; }
        if(ghost!=null){ ghostEl.style.left = (Math.max(0,Math.min(1,ghost))*100)+'%'; ghostEl.style.display='block'; } else { ghostEl.style.display='none'; }
        let fsm = snap?.fsm || (snap?.gate===false?'GATED':(norm!=null? (norm<enterPct?'Armed': (norm<exitPct?'Held':'Released')):'?'));
        st.textContent = `${fsm}${snap?.palmAngleDeg!=null? ' | palm '+snap.palmAngleDeg.toFixed(0)+'°':''}`;
        const hist = Array.isArray(snap?.history)? snap.history : []; spark.width=W; spark.height=H; const sctx=spark.getContext('2d'); sctx.clearRect(0,0,W,H);
        if(hist.length){ sctx.strokeStyle='#94a3b8'; sctx.lineWidth=1; sctx.beginPath(); for(let i=0;i<hist.length;i++){ const x = (i/(hist.length-1))*W; const y = H - (hist[i].norm!=null? hist[i].norm:0)*H; if(i===0) sctx.moveTo(x,y); else sctx.lineTo(x,y); } sctx.stroke(); }
      }

      // WEBWAY:ww-2025-059: Autostart Dino P1 sidecar and mirror valid pinch as Space
  const __params = new URLSearchParams(location.search);
      const FLAG_V6_DINO_P1 = ((__params.get('flag_v6_dino_p1') ?? '1') !== '0');
  // WEBWAY:ww-2025-062: Feature flags for panel and seat-based strips
  const FLAG_PANEL_CARD = ((__params.get('panel_card') ?? '0') === '1');
  const FLAG_SEAT_STRIPS = ((__params.get('seat_strips') ?? '0') === '1');
      let dinoFrame; let dino; let dinoAttached = false; let dinoWindow; let dinoWinChrome; let dinoWinBody; let btnDinoClose;
      if(FLAG_V6_DINO_P1){
        // Floating window container
        dinoWindow = document.createElement('div'); dinoWindow.id='dinoWindowV6';
        dinoWindow.style.cssText='position:fixed; top:84px; left:84px; width:520px; height:320px; z-index:1000;';
        dinoWinChrome = document.createElement('div'); dinoWinChrome.id='dinoWinChromeV6';
        dinoWinChrome.className='flex items-center justify-between px-2 py-1 select-none';
        dinoWinChrome.style.cssText='cursor:move; background: color-mix(in oklab, var(--m3-surface) 86%, black 14%); border:1px solid var(--m3-outline); border-bottom:none; border-top-left-radius:8px; border-top-right-radius:8px;';
        dinoWinChrome.innerHTML = `<div class="text-[12px] font-semibold">T-Rex Runner <span class="chip ml-2">Seat: P1</span></div><div class="flex items-center gap-1"><button id="btnDinoCloseV6" class="chip" title="Close">Close</button></div>`;
        dinoWinBody = document.createElement('div'); dinoWinBody.id='dinoWinBodyV6';
        dinoWinBody.style.cssText='background: color-mix(in oklab, var(--m3-surface) 92%, black 8%); border:1px solid var(--m3-outline); border-top:none; border-bottom-left-radius:8px; border-bottom-right-radius:8px; width:100%; height:calc(100% - 30px); display:flex; align-items:stretch;';
        dinoWindow.appendChild(dinoWinChrome); dinoWindow.appendChild(dinoWinBody); document.body.appendChild(dinoWindow);
        dinoFrame = document.createElement('iframe'); dinoFrame.id = 'dino_v6'; dinoFrame.title='T-Rex Runner (P1)';
        Object.assign(dinoFrame.style, { width:'100%', height:'100%', border:'0', background:'#0c1117', borderRadius:'0 0 8px 8px' });
        dinoWinBody.appendChild(dinoFrame);
        dino = createDinoSidecar({ target: window });
        window.__dino_v6 = dino;
        // Close button
        btnDinoClose = dinoWinChrome.querySelector('#btnDinoCloseV6');
        btnDinoClose?.addEventListener('click', ()=>{ try{ dinoWindow.style.display='none'; }catch{} });
        // Dragging
        (function enableDrag(){
          let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;
          function onMove(e){ if(!dragging) return; const dx=(e.clientX-startX), dy=(e.clientY-startY); dinoWindow.style.left=(startLeft+dx)+"px"; dinoWindow.style.top=(startTop+dy)+"px"; }
          function onUp(){ dragging=false; window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); }
          dinoWinChrome?.addEventListener('mousedown', (e)=>{ dragging=true; startX=e.clientX; startY=e.clientY; const rect=dinoWindow.getBoundingClientRect(); startLeft=rect.left; startTop=rect.top; window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp); });
        })();
      }

      function configureDinoBridge(w){
        if(!w) return;
        dino.setParams({ target: w, code: 'Space', key: ' ', seat: 'P1' });
        try{
          w.__dinoEcho = 0;
          w.addEventListener('message', (ev)=>{
            const msg = ev && ev.data; if(!msg || msg.type!=='dino:key') return;
            const type = msg.action === 'down' ? 'keydown' : 'keyup';
            const init = { code:'Space', key:' ', bubbles:true, cancelable:true, keyCode:32, which:32 };
            const Evt = w.KeyboardEvent || KeyboardEvent; const kev = new Evt(type, init);
            try { Object.defineProperty(kev, 'keyCode', { get: ()=>32 }); } catch {}
            try { Object.defineProperty(kev, 'which', { get: ()=>32 }); } catch {}
            try { w.document && w.document.dispatchEvent && w.document.dispatchEvent(kev); }catch{}
            try { w.dispatchEvent && w.dispatchEvent(kev); }catch{}
            try { const canvas = w.document && w.document.querySelector && w.document.querySelector('canvas'); if(canvas) canvas.dispatchEvent(kev); }catch{}
            if(type==='keydown'){
              try{ w.__dinoEcho = (w.__dinoEcho||0) + 1; }catch{}
              try{ window.postMessage({ type:'dino:echo', count: w.__dinoEcho }, '*'); }catch{}
            }
          });
        }catch{}
        try{ const doc=w.document; const canvas=doc?.querySelector('canvas'); canvas?.focus?.(); canvas?.click?.(); w.focus?.(); }catch{}
        try{ let tries=0; const max=24; const iv=setInterval(()=>{ try{ if((w.__dinoEcho||0)>0 || tries>=max){ clearInterval(iv); return; } const c=w.document?.querySelector('canvas'); c?.focus?.(); c?.click?.(); w.focus?.(); tries++; }catch{ clearInterval(iv); } }, 250); }catch{}
      }

  // Autostart Dino iframe immediately; delay sidecar attach until P1 lock
  (function startDino(){ if(!FLAG_V6_DINO_P1) return; try{ dinoFrame.src = '../vendor/dino/index.html'; dinoFrame.onload = ()=> configureDinoBridge(dinoFrame.contentWindow); }catch(e){ console.warn('Dino autostart failed', e);} })();

      // Capture echo count for tests/diagnostics
      try{ window.addEventListener('message', (ev)=>{ try{ const d = ev && ev.data; if(d && d.type==='dino:echo'){ window.__diag = window.__diag || {}; window.__diag.dinoEcho = d.count; } }catch{} }); }catch{}

      // Lock-in state
      const lock = { P1: null, P2: null, order: [] };
      function tryLock(e){
        const seat = e.seat || seatFromHand(e.hand);
        if(e.type === 'pinch:down' && (seat==='P1' || seat==='P2')){
          if(!lock[seat]){ lock[seat] = { t: e.t || performance.now(), hand: e.hand||null, handId: e.handId??null }; lock.order.push(seat); }
          // On first P1 lock, attach dino and synthesize a Space press to mirror the lock-in
          if(FLAG_V6_DINO_P1 && seat==='P1' && !dinoAttached){
            try{ dino.setParams({ seat:'P1' }); dino.attach({ sdk }); dinoAttached = true; }catch{}
            try{ const w = dinoFrame?.contentWindow; if(w){ w.postMessage({ type:'dino:key', action:'down', code:'Space', key:' ' }, '*'); setTimeout(()=>{ try{ w.postMessage({ type:'dino:key', action:'up', code:'Space', key:' ' }, '*'); }catch{} }, 60); } }catch{}
          }
        }
      }

      // Render HUD badges/logs
      function renderHud(){
        p1Badge.textContent = lock.P1? '1/1' : '–';
        p2Badge.textContent = lock.P2? '1/1' : '–';
        const st = sdk.getState?.();
        const rich=sdk.getRichSnapshot?.();
        // Toggle panel content based on flag
        if(FLAG_PANEL_CARD){ if(seatCards) seatCards.style.display='block'; if(legacyPanelBlocks) legacyPanelBlocks.style.display='none'; }
        else { if(seatCards) seatCards.style.display='none'; if(legacyPanelBlocks) legacyPanelBlocks.style.display='block'; }
        // Legacy JSON blocks
        if(!FLAG_PANEL_CARD){ if(st) elState.textContent = JSON.stringify(st, null, 2); if(Array.isArray(rich)){ const last = rich.slice(-24).map(s=>({ seat: s.seat||seatFromHand(s.hand), norm: +(s.norm??0).toFixed(3), fsm: s.fsm||undefined })); elRich.textContent = JSON.stringify(last, null, 2); } }
        // Seat cards
        if(FLAG_PANEL_CARD && Array.isArray(rich)){
          const latestBySeat = { P1:null, P2:null };
          for(let i=rich.length-1;i>=0;i--){ const s = rich[i]; const seat = (s.seat || seatFromState(st, s) || seatFromHand(s.hand)); if((seat==='P1' || seat==='P2') && !latestBySeat[seat]) latestBySeat[seat]=s; if(latestBySeat.P1 && latestBySeat.P2) break; }
          const p1 = latestBySeat.P1; const p2 = latestBySeat.P2;
          p1Card.badge.textContent = lock.P1? '1/1' : '–'; p1Card.hand.textContent = (lock.P1?.hand || p1?.hand || '–'); p1Card.fsm.textContent = (p1?.fsm || (p1?.norm!=null? (p1.norm < (p1?.thresholds?.enter??0.5)?'Armed': (p1.norm < (p1?.thresholds?.exit??0.8)?'Held':'Released')) : '–')); p1Card.norm.textContent = (p1?.norm!=null? p1.norm.toFixed(3) : '–');
          p2Card.badge.textContent = lock.P2? '1/1' : '–'; p2Card.hand.textContent = (lock.P2?.hand || p2?.hand || '–'); p2Card.fsm.textContent = (p2?.fsm || (p2?.norm!=null? (p2.norm < (p2?.thresholds?.enter??0.5)?'Armed': (p2.norm < (p2?.thresholds?.exit??0.8)?'Held':'Released')) : '–')); p2Card.norm.textContent = (p2?.norm!=null? p2.norm.toFixed(3) : '–');
        }
      }

      // Draw loop (overlay + strips)
      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        try{ overlay.draw(); }catch{}
        const state=sdk.getState?.()||{}; const rich=sdk.getRichSnapshot?.()||[];
        const now = performance.now();
        if(FLAG_SEAT_STRIPS){
          // WEBWAY:ww-2025-062: seat-based strips
          const latestBySeat = { P1:null, P2:null };
          for(let i=rich.length-1;i>=0;i--){ const s = rich[i]; const seat = (s.seat || seatFromState(state, s) || seatFromHand(s.hand)); if((seat==='P1' || seat==='P2') && !latestBySeat[seat]) latestBySeat[seat]=s; if(latestBySeat.P1 && latestBySeat.P2) break; }
          for(const seat of ['P1','P2']){
            const snap = latestBySeat[seat]; if(!snap || snap.norm==null) continue;
            const seatKey = `seat:${seat}`;
            const row = ensureStrip(seatKey, seat);
            const k = getKalman(seatKey);
            const r = k.step({ t: now, norm: snap.norm, enterThresh: (snap?.thresholds?.enter ?? 0.5) });
            const dtAhead = Math.max(0, (+laEl?.value||0)/1000);
            const ghost = r.x + r.v * dtAhead;
            renderStrip(row, snap, ghost);
            try{ tti.update({ now, handKey: seatKey, snap, kalman: r, enterThresh: (snap?.thresholds?.enter ?? 0.5) }); }catch{}
          }
        }else{
          // Legacy: hand-keyed strips
          for(const snap of rich){ if(snap?.norm==null) continue; const handKey = snap.hand + ':' + (snap.handId ?? '?');
            const seat = (snap.seat || seatFromState(state, snap) || seatFromHand(snap.hand) || '?');
            const row=ensureStrip(handKey, `${seat}${seat==='?'?'':''}`);
            const k = getKalman(handKey); const r = k.step({ t: now, norm: snap.norm, enterThresh: (snap?.thresholds?.enter ?? 0.5) });
            const dtAhead = Math.max(0, (+laEl?.value||0)/1000);
            const ghost = r.x + r.v * dtAhead;
            renderStrip(row, snap, ghost);
            try{ tti.update({ now, handKey, snap, kalman: r, enterThresh: (snap?.thresholds?.enter ?? 0.5) }); }catch{}
          }
        }
      }
      (function raf(){ draw(); renderHud(); requestAnimationFrame(raf); })();

      // Wire events for lock-in
      try{
        sdk.on(e=>{ if(e && typeof e.type==='string' && e.type.startsWith('pinch:')) tryLock(e); });
      }catch{}

      // WEBWAY:ww-2025-059: Guard
      // Ready sentinel: require P1 lock and at least one Dino echo
      function updateReady(){ try{
        const el = document.getElementById('e2eReady'); if(!el) return;
        const ok = !!(lock.P1 && (!FLAG_V6_DINO_P1 || (window.__diag && window.__diag.dinoEcho >= 1)));
        const ready = ok ? '1' : '0'; el.dataset.ready = ready; el.textContent = ready;
      }catch{} }
      setInterval(updateReady, 200);

      // Controls
      btnStart.addEventListener('click', async()=>{ try{ await sdk.startCamera(video);}catch(e){ console.error(e);} });
      btnStop.addEventListener('click', ()=>{ sdk.stop(video); resetAllKalman(); });
      async function playUrl(url){ try{ try{ video.crossOrigin='anonymous'; }catch{} await sdk.startVideoUrl(video,url); setTimeout(()=>{ try{ video.muted=true; video.play&&video.play().catch(()=>{}); }catch{} }, 50); }catch(e){ console.error('Failed to play url',url,e);} }
      const PINCH_URL='/September2025/TectangleHexagonal/videos/golden/golden.two_hands_pinch_seq.v1.mp4'; const IDLE_URL='/September2025/TectangleHexagonal/videos/golden/golden.two_hands_idle.v1.mp4';
      btnPlayPinch.addEventListener('click', ()=> playUrl(PINCH_URL)); btnPlayIdle.addEventListener('click', ()=> playUrl(IDLE_URL));
      fileInput.addEventListener('change', async (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const blobUrl=URL.createObjectURL(f); await playUrl(blobUrl); });

      // URL params for automation
      (async function autoStartFromQuery(){
        try{
          const p = new URLSearchParams(location.search);
          let clip = p.get('clip'); const autostart = p.get('autostart')==='1';
          if(p.get('hud')==='1'){ try{ const hud=document.getElementById('lockHud'); if(hud) hud.style.display='grid'; }catch{} }
          if(p.get('seatcfg')==='1'){ const box=document.getElementById('seatcfg'); if(box) box.style.display='block'; }
          if(autostart && clip){ try{ if(!/^\//.test(clip)) clip = '/' + clip; video.muted=true; video.autoplay=true; }catch{}; await playUrl(clip); }
          // Apply panel/strip flags from query as fallback
          if(p.get('panel_card')==='1'){ try{ seatCards.style.display='block'; legacyPanelBlocks.style.display='none'; }catch{} }
          if(p.get('seat_strips')==='1'){ /* rendering path handled in draw() */ }
        }catch(e){ console.warn('autostart params failed', e); }
      })();

      // Expose lock summary for tests
      window.__lockSummary = ()=> ({ P1: !!lock.P1, P2: !!lock.P2, order: lock.order.slice(0) });
    </script>
  </body>
</html>
