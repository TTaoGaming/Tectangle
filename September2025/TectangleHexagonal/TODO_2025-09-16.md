<!--
STIGMERGY REVIEW HEADER
Status: Pending verification
Review started: 2025-09-16T19:48-06:00
Expires: 2025-09-23T19:48-06:00 (auto-expire after 7 days)

Checklist:
- [ ] Re-evaluate this artifact against current Hexagonal goals
- [ ] Log decisions in TODO_2025-09-16.md
-->

# TODO — 2025-09-16 (Arcade Multi-Hand Single-Pinch MVP)

Primary Outcome (money path): Ship a reliable local multiplayer (2P initial, scaffold 4P) one‑button pinch arcade harness that can host simple OSS mini‑games (Dino, Reaction, Rhythm) with stable controller IDs (P1/P2) and low false positives.

## North Star (Phase 0 Revenue Gate)

- A guest can walk up, pinch to jump/play within 10 seconds.
- Two players can concurrently pinch; seats never duplicate; lost hand seamlessly reacquires same seat.
- Normal pinch clip: downs=1 ups=1 (0 false). Gated clip: downs=0 ups=0. Spec cancel rate ≤10%.
- Mean down latency 60–200 ms; no frame with duplicate controllerId.

## Critical Path (Do First)

1. Seat & Concurrency Core (no duplicates, peak-based cap, stale/reacquire).
2. Pinch Stability (confirm windows, debounce, velocity sign check; optional angle plausibility).
3. Arcade Harness Page + Game Bridge (maps pinch events → generic GAME_BUTTON events for mini‑games).
4. Telemetry & Contracts (seat/pinch metrics + watchdog invariants).
5. E2E & Unit Coverage (synthetic traces + real clip scenarios).
6. Performance Guard (<0.3 ms/frame added).

## KPIs / Metrics

| Domain | Metric | Target |
|--------|--------|--------|
| Pinch | falseDownRate | < 2% (clips) |
| Pinch | specCancelRate | ≤ 10% |
| Seats | duplicateSeatFrames | 0 |
| Seats | improperUnlocks (seatId > peak) | 0 |
| Seats | reacquireSuccess (valid reacquire / attempts) | ≥ 90% |
| Perf | addedFrameCostMs (avg) | < 0.3 |

## Invariants

- INV1: At most one active controllerId per seat per frame.
- INV2: Highest seat issued ≤ peakConcurrentHands (smoothed window).
- INV3: Seat stickiness: seat retained for staleTimeoutMs after last seen.
- INV4: Reacquire: new wrist within reacquireRadius of last seat position before new seat issuance.
- INV5: Seat IDs remain compact (fill 1..N before N+1). No gaps.
- INV6: No seat reassign unless stale OR explicit reset.
- INV7: Peaks require sustainFrames ≥ threshold (avoid transient unlock).

## Feature Flags

- FEATURE_MULTISEAT_V2: Enables new seat core (controller router upgrade).
- PINCH_STABILITY_V1: Confirm windows + debounce + velocity sign.
- FEATURE_PARRY_ADAPTER (existing) — orthogonal; ensure compatibility.
- ARCADE_MONETIZE_EXP1 (later) — optional donation / session overlay.

## Modules (Planned)

- src/core/seatConcurrencyCore.js — pure logic (update(hands,t)).
- src/app/controllerRouterCore.js (extend) or src/core/controllerSeatsCore.js — seat FSM integration.
- src/adapters/gameEventBridge.mjs — pinch events → GAME_BUTTON_P{n}_DOWN/UP.
- dev/arcade_harness.html — select mini‑game iframe, show seat HUD.
- tests/unit/seatConcurrencyCore.test.mjs — peak, stale, reacquire.
- tests/e2e/arcade_multiseat.test.cjs — full seat + game event flow.

## Event Extensions

- concurrency:updated { current, peakWindow }
- seat:assigned { seatId, handSig, t }
- seat:reacquired { seatId, gapMs }
- seat:stale { seatId }
- seat:released { seatId }
- game:button { seatId, type: down|up, t }

## Config Parameters (Defaults)

- staleTimeoutMs: 800
- seatIdleMs: 1500
- peakWindowMs: 2500
- sustainFramesForPeak: 4
- reacquireRadius: 0.12 (normalized)
- flipGraceMs: 500
- confirmDownMs: 40 (flagged)
- confirmUpMs: 80 (flagged)
- debounceMs: 80 (flagged)

## Test Matrix

| Scenario | Expectation |
|----------|-------------|
| Two hands appear sequentially | Seats P1 then P2 assigned, no duplicate |
| Lose P2 short (< staleTimeoutMs) then return near last pos | Reacquire seatId=2 (reacquired) |
| Lose P2 long (> seatIdleMs) new hand far | P2 released then re-assigned with new assigned event |
| Rapid flicker (occlusion) | No seat flip; no duplicate controller events |
| Gated clip | zero pinch downs/ups |
| Normal pinch clip | one down/up; latency within band |
| Performance harness (1000 frames synthetic) | avg added <0.3 ms |

## Telemetry Fields (Additive)

- seatsActive, peakSeats
- seatEvents[] (type, seatId, dt)
- pinchStats { downs, ups, specCancels, meanDownLatencyMs }

## Revert Path

1. Remove FEATURE_MULTISEAT_V2 & PINCH_STABILITY_V1 usages in main.
2. Delete seatConcurrencyCore module + arcade harness page + gameEventBridge.
3. Remove Webway note ww-2025-006 and README marker.
4. Remove added tests (unit/e2e) and telemetry optional fields (safe—optional).

## Parallel Work Streams

- Core Logic: Tasks 2,4
- Pinch Reliability: Task 3
- Harness + Bridge: Tasks 6,7
- Testing: Tasks 8,9,14
- Telemetry/Contract: Tasks 5,10
- Docs/Governance: Tasks 1,11,15
- Monetization: Task 13 (after core stable)

## Task Breakdown (Mapped to Global TODO IDs)

1 → Spec (this file + spec doc)
2 → seatConcurrencyCore
3 → Pinch stability additions
4 → Reacquire + stale logic integration
5 → Telemetry extensions
6 → Arcade harness page
7 → Game event bridge adapter
8 → E2E multiseat test
9 → Unit test coverage
10 → Feature flag wiring (core & main)
11 → Webway note ww-2025-006
12 → Kiosk startup script
13 → Monetization overlay experiment
14 → Performance instrumentation
15 → Revert validation

## Deferred / Later

- 3–4 seat scaling & dynamic layout.
- Advanced ID (biomech fingerprint) calibration harness.
- Rhythm timing compensation (negative latency) for music games.
- MPE / multi-axis pinch expression (beyond single-button).

## Audit 2025-09-16 (Codex)

- Pinch stability improvements (span EMA clamp + hold deadzone + gating) landed in `src/core/pinchCore.js`; UI exposes toggles in `dev/index.html` and `src/app/main.js`.
- Controller router handles pairing, reservations, and proximity reacquire in `src/app/controllerRouterCore.js`; covered by the new unit suites and the smoke harness `tests/smoke/run_video_check_seats.mjs`.
- Workflow guardrails exist: tiered Husky hooks call `hex:lint-arch:cached`/focused tests and `hex:contract` (`.husky/pre-commit`, `.husky/pre-push`), and `hex-daily` workflow runs `hex:verify:*`.

### Gaps / Risks

- `src/core/seatConcurrencyCore.js` is still unimplemented, so `tests/unit/seatConcurrencyCore.test.mjs` only skips/fails; concurrency unlock window + sustain logic remain TODO.
- Telemetry snapshot in `src/app/main.js` still reports only pinch counts; seat metrics/invariants from the plan are absent, leaving `hex:contract` with little to assert.
- Arcade harness + `gameEventBridge` modules have not been started (no files at the planned paths), and feature flags `FEATURE_MULTISEAT_V2` / `PINCH_STABILITY_V1` are unused.
- Controller cap currently uses a monotonic `maxConcurrent` (no peak window or stale drop) in `src/app/controllerRouterCore.js`, and `faultline/map.json` remains empty, so planned governance signals are missing.
---
Created: 2025-09-16
Marker: <!-- TODO:2025-09-16:Arcade-MVP -->

## Prototype Migration Audit (Added 2025-09-16)

Goal: Identify which demo prototypes should have logic extracted into hexagonal core/services/components, which can be slim shells, and which can be archived or removed.

Legend:
- Extract Core: Promote pure logic (state machines, transforms) into `src/core/*`.
- Extract Service: Orchestrator that coordinates cores (app layer) into `src/app/*`.
- Presenter/UI: Move one-off drawing into presenter + adapter or component in `src/presenters` / `src/ui`.
- Keep (Shell): Keep minimal HTML wrapper calling AppShell.
- Deprecate: No longer needed once other extractions land; can archive.

| Prototype (dev/) | Primary Purpose Today | Gaps vs Hex | Needed Extractions (Core / Service / Presenter) | Recommended Action | Notes / Next Step | Flag Candidate |
|------------------|-----------------------|-------------|-----------------------------------------------|--------------------|-------------------|----------------|
| index.html | Baseline pinch + UI toggles | Inline wiring; mixed concerns | Service: AppShell; Presenter: overlay; (core already) | Extract → Thin Shell | Repoint to `createAppShell()` after HandSessionManager | FEATURE_UI_REFACTOR |
| pairing_sidecar_demo.html | Seat pairing + overlay visual | Manual pinch core mgmt; direct canvas | Service: HandSessionManager; Presenter; Concurrency state panel | Extract → Thin Shell | Migrate ensureCore logic first | FEATURE_MULTISEAT_V2 |
| pinch_dino.html | 1‑button game integration (Dino) | Game bridge ad hoc; pinch direct | Core: (none) Service: gameEventBridge; Presenter reuse | Extract & Keep | Replace direct events with GAME_BUTTON bridge | FEATURE_GAME_BRIDGE |
| ghost_predictive_pinch_dino.html | Predictive pinch experiment | Predictive logic inline; no abstraction | Core: predictivePinchModel; Service: predictiveWrapper | Extract (selective) | Isolate prediction model w/ tests; fallback if flag off | FEATURE_PRED_PINCH |
| predictive_tube_demo.html | Hysteresis tube + prediction UI | Lacks reusable hysteresis core | Core: hysteresisSignal; UI: HysteresisTube | Extract then Deprecate | After component exists, archive demo | FEATURE_UI_HYSTERESIS |
| ghost_hysteresis_tube.html | Combined ghost + tube visual | Same as above + predictive mixing | Reuse hysteresis + prediction cores | Fold & Deprecate | Superseded by unified component stories | (inherits) |
| ghost_hysteresis.html | Raw hysteresis experimentation | Prototype-only, superseded | None (once core extracted) | Deprecate | Archive after tests for hysteresisSignal | — |
| pinch_flappy.html | Alt 1‑button game (Flappy) | Duplicate logic from pinch_dino | Service: gameEventBridge | Keep (Shell) | Use shared bridge; remove duplicate pinch code | FEATURE_GAME_BRIDGE |
| ring_index_demo.html | Index vs thumb visualization | Inline measurement logic | Core: ringMetric (optional) Presenter: overlay ext | Extract (maybe) | If metric reused, promote; else archive | FEATURE_RING_METRICS |
| controller_router_lab.html | Seat router inspection | Direct internal poking | Presenter: seat state panel | Keep (Diagnostic) | Point at same AppShell + debug overlay | FEATURE_MULTISEAT_V2 |
| hand_id_lab.html | Hand identity labeling | Legacy ID check | None (low reuse) | Deprecate | Archive after HandSessionManager stable | — |
| hand_tracker_t1_lab.html | Early tracking smoke | Obsolete | None | Delete | Remove after confirmation no unique logic | — |
| hand_calibrate_sidecar.html | Calibration sidecar | Not integrated with services | Service: calibrationManager (later) | Park (Defer) | Plan after Arcade MVP revenue gate | FEATURE_CALIB_SIDE |
| fingertip_sphere.html | Fingertip spatial debug | Inline rendering only | Presenter: 3D fingertip (future maybe) | Keep (Low Priority) | Leave as is until 3D UI pass | FEATURE_3D_DEBUG |
| toi_demo.html | TOI interaction concept | Ad hoc gating | Core: toiGesture (later) | Defer | Not on MVP path | FEATURE_TOI_EXP |
| canned_hand_id_test_prototype.html | Replay canned IDs | Needs frame source abstraction | Port: RecordedFrameSource | Extract Port then Deprecate | Use for contract tests; then archive | FEATURE_REPLAY_PORT |
| lab_rings.html | Ring landmarks test | Low reuse | None | Deprecate | Archive w/ ring_index_demo if metric unused | — |
| visual-webcam.html (archived) | Pure webcam preview | Obsolete | None | Delete | Provided by upstream libs now | — |

### Migration Sequencing (Incremental)

1. HandSessionManager (unblocks index + pairing_sidecar_demo consolidation).
2. HysteresisSignal + HysteresisTube component (retire predictive_tube_demo & ghost_hysteresis variants).
3. GameEventBridge (normalize pinch → GAME_BUTTON for pinch_dino / pinch_flappy).
4. OverlayPresenter (centralized view model; simplifies multiple shells).
5. PredictivePinchModel core (only keep ghost predictive page until validated; then fold under a feature flag).

### New / Adjusted TODO References

- Add tasks for: predictive pinch core, game event bridge (already task 7), hysteresis signal (task 18), replay frame source port (new), calibration manager (deferred), ring metric (conditional), predictive pinch model (new).

### Decisions

- Keep only one canonical “arcade harness” page for games; individual game pages become optional shells or removed after harness proven.
- Demos that only visualized a now-extracted core become Storybook-style component stories (task 21) or archived.

### New Decision (2025-09-17)

- ID: DEC-2025-09-17-01 (WEBWAY:ww-2025-011)
  - Change: Adopt responsive camera constraint pipeline + tri-state landmark space detection (neg1to1|unit|pixel) in `overlayOpsPort`.
  - Intent: Eliminate double normalization causing inward overlay bias; enable live resolution/FPS tuning for comparative latency/clarity tests.
  - Guard: Unit tests `camera.constraints.test.mjs`, `overlay.normalization.detect.test.mjs`; manual visual QA with `FEATURE_OVERLAY_DEBUG`.
  - Revert: Remove `FEATURE_CAMERA_CONSTRAINTS` UI & APIs; collapse `detectSpace` back to legacy; delete scaffold note `webway_ww-2025-011-responsive-camera.md`.
  - TTL: 2025-10-08 (see scaffold front‑matter) — review adoption & either graduate (remove flag) or revert.


## Progress 2025-09-16 (HandSessionManager / AppShell)

- HandSessionManager now wraps pinch cores and emits unified events per hand; old page wiring can call `createHandSessionManager` instead of rolling their own (`src/app/handSessionManager.js`).
- AppShell prototype (`src/app/appShell.js`, `dev/appshell_demo.html`) pipes MediaPipe frames -> HandSessionManager -> ControllerRouter, giving us a reusable harness for multi-hand demos (covers Task 6).
- Added `run_video_appshell_check_seats.mjs` smoke to make sure the shell assigns distinct seats under automation.
- LookAhead core landed as a pure domain helper (`src/core/lookAheadCore.js`) with unit tests; ready to drive predictive UI once we expose it via ports (progress toward Task 3/Task 14).

### Remaining / Next

- Run the pinch stability clip checks and tune PALMGATE toggles (`TODO_today` second bullet) so the new shell has baseline metrics.
- Plug look-ahead predictions into HandSessionManager ? AppShell pipeline, then surface them to the ghost/predictive demos before integrating mini-game bridges.
- Promote seat concurrency logic into the router (Task 2) so reacquire behavior lines up with the new shell smoke expectations.
- Anchor joystick core landed (src/core/anchorJoystickCore.js) and is wired through HandSessionManager behind FEATURE_ANCHOR_JOYSTICK; emits nchor:start/update/end without touching existing flows.
- Anchor joystick demo now falls back to sample clip and exposes automation helpers; smoke test added (run via npm run hex:smoke:anchor).

### Codex Review Notes (2025-09-16)
- Responsive camera constraint controls now live in `src/app/appShell.js` and `dev/integrated_hand_console_v7.html` behind `FEATURE_CAMERA_CONSTRAINTS`; log follow-up to measure impact on Task 6 harness latency and Task 18 overlay spans.
- HandSessionManager still does not instantiate `createAnchorJoystickCore`; update Task 3 wiring notes so `FEATURE_ANCHOR_JOYSTICK` reflects actual status before declaring done.
- `tests/smoke/run_anchor_joystick_demo.mjs` currently pokes debug helpers; plan an automation path that uses recorded pinch clips once anchor wiring is in place.
