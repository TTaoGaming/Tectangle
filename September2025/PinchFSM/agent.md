# PinchFSM Agent Guide

Purpose: Provide operational ground rules and context so automated agents (AI assistants, CI bots) interact safely and productively with this subproject.

## 1. Core Domain Snapshot

- Goal: Deterministic pinch gesture state machine (Strike/Lift) built from per-frame hand landmarks.
- Canonical inputs: JSONL landmark traces generated by Human (not webcam live streams) in `data/goldens/`.
- Determinism pillars: fixed fps=30, frameIndex→timestampMs, pinned Human version & models, no smoothing at extraction time.

## 2. Key Directories

- `scripts/` – automation (extraction, freezing, verification).
- `src/` – schemas and (future) FSM runner logic.
- `tests/` – schema validation for goldens.
- `data/goldens/` – live goldens and frozen snapshots.
- `docs/two-pagers/` – strategy/tactical design references (CI, golden master, Actions).

## 3. Commands Contract

| Intent | Command | Notes |
| ------ | ------- | ----- |
| Verify environment | `npm run verify` | ffmpeg, versions, assets. |
| Generate goldens | `npm run human:extract` | Produces/overwrites JSONL landmark traces. |
| Test schema | `npm test` | Validates all goldens shape. |
| Freeze snapshot | `npm run goldens:freeze` | Copies current JSONL to timestamped folder + manifest. |
| Regenerate + freeze | `npm run goldens:curate-freeze` | For intentional updates. |
| Verify frozen integrity | `npm run goldens:verifyFrozen` | Checks sha256, size, frame count vs manifest. |
| Full CI locally | `npm run ci` | Mirrors required workflow lane. |

## 4. Golden Freezing Rules

- Never delete existing `data/goldens/frozen/*` directories.
- Only update `manifest.current.json` via freeze scripts (no manual edits).
- If extraction output changes unexpectedly: do NOT freeze—investigate first.
- Each freeze produces: `frozen/<UTC_STAMP>/manifest.json` + copied JSONL files.

## 5. Change Policy for Agents

| Scenario | Allowed Action | Rationale |
| -------- | -------------- | --------- |
| Refactor (no output change) | Run tests only | Avoid accidental golden churn. |
| Intentional behavior change | `human:extract` + `goldens:curate-freeze` | Captures new canonical inputs. |
| Adding new test video | Add MP4 → extract → freeze | Expands scenario coverage. |
| CI failure due to drift | Report diff & halt | Maintains trust in goldens. |

## 6. Safety & Idempotence Guidelines

- Treat JSONL goldens as immutable once frozen; never edit in-place.
- Avoid introducing randomness in extraction or test steps.
- All scripts must be re-runnable without side-effects other than deterministic rewrites of live goldens.

## 7. Logging & Artifacts

- Extraction writes human-readable progress plus writes JSONL to `data/goldens/`.
- CI uploads JSONL files + server logs for traceability.
- Future: event replay reports (to be added) should also be artifacted.

## 8. Extensibility Hooks (Forthcoming)

- `PinchFSMRunner` (planned) will consume frozen traces for event generation.
- Event comparator will enforce hysteresis and timing invariants.
- Add performance budget step (latency, FP rate) in nightly lane.

### 8.a Upcoming Smoothing Layer (OneEuro)

Purpose: Provide optional low-latency noise reduction before pinch metric computation without altering canonical raw goldens.

Principles

- Raw JSONL remains source of truth; smoothing outputs live in `data/goldens/derived/`.
- OneEuro filter params (minCutoff, beta) stored in a committed `smoothing.oneeuro.json` config.
- Any param or algorithm change → regenerate derived files + (optional) freeze derived manifest segment.
- Deterministic: use provided frame timestamps; no wall-clock time.

Slice Order (work small)

1. Add `src/filters/oneEuro.ts` with pure OneEuro class + unit test for simple ramp input.
2. Add smoothing script `scripts/oneeuro-smooth.mjs` that reads one JSONL, writes derived JSONL.
3. Extend Zod schema (if needed) for derived file manifest metadata.
4. Add test ensuring line count parity and identical timestamps.
5. (Later) Integrate into pinch metric generation pipeline.

Never: overwrite raw files; always write to `derived/`.

## 9. What Agents Must NOT Do

- Do NOT auto-freeze after every extraction.
- Do NOT modify existing frozen manifests.
- Do NOT fetch remote models at runtime (must use local vendored assets).
- Do NOT bypass schema tests when updating goldens.

## 10. Escalation Protocol

1. Capture failing file hashes (`sha256sum <file>` or script output).
2. Open an Issue or PR with: commit hash, failing file, expected vs actual hash/frames/size.
3. Include rationale if proposing an intentional golden update.
4. Block merges until discrepancy resolved.

## 11. Metadata & Provenance

- Manifest includes: createdAt, commit, dependency versions, per-file sha256, frame counts.
- Use this to audit changes over time and correlate regressions.

## 12. Quick Decision Tree

```text
Change outputs intentionally? -> Yes -> regenerate + curate-freeze -> commit PR with rationale.
                              -> No  -> run tests -> if drift detected -> investigate.
Unexpected CI drift? -> Investigate (do not freeze) -> fix root cause -> re-run.
Need new scenario? -> Add MP4 -> extract -> freeze -> commit.
```

## 13. Future Automation Ideas

- Bot PR template injection for golden updates (rationale checklist).
- Auto-diff visual overlay generation on golden change PRs.
- Periodic integrity audit comparing all frozen manifests against current tool versions.
- Derived file drift reporter (raw vs smoothed variance distribution) for parameter tuning.

---
Revision: 2025-09-05
